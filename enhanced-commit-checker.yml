# ë” ì •í™•í•œ ì»¤ë°‹ ìˆ˜ì§‘ì„ ìœ„í•œ ê³ ê¸‰ ì›Œí¬í”Œë¡œìš°

      - name: Enhanced commit checking with multiple APIs
        id: enhanced_check_commits
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USERNAME="${{ github.repository_owner }}"
          EXCLUDED_REPOS="weekly-commit-challenge"
          
          # ì£¼ì°¨ ê³„ì‚° (ê¸°ì¡´ê³¼ ë™ì¼)
          CURRENT_WEEKDAY=$(TZ='Asia/Seoul' date '+%u')
          if [ "$CURRENT_WEEKDAY" -eq 1 ]; then
            WEEK_START=$(TZ='Asia/Seoul' date -d '7 days ago' '+%Y-%m-%d')
            WEEK_END=$(TZ='Asia/Seoul' date -d '1 day ago' '+%Y-%m-%d')
          else
            DAYS_SINCE_MONDAY=$((CURRENT_WEEKDAY - 1))
            WEEK_START=$(TZ='Asia/Seoul' date -d "$DAYS_SINCE_MONDAY days ago" '+%Y-%m-%d')
            WEEK_END=$(TZ='Asia/Seoul' date -d '1 day ago' '+%Y-%m-%d')
          fi
          
          SINCE_DATE=$(TZ='Asia/Seoul' date -d "$WEEK_START 00:00:00" -Iseconds)
          UNTIL_DATE=$(TZ='Asia/Seoul' date -d "$WEEK_END 23:59:59" -Iseconds)
          
          echo "ğŸ” ë‹¤ì¤‘ APIë¡œ ì •í™•í•œ ì»¤ë°‹ ìˆ˜ í™•ì¸ ì¤‘..."
          echo "ê¸°ê°„: $WEEK_START ~ $WEEK_END"
          
          # ë°©ë²• 1: GraphQL API (ê°€ì¥ ì •í™•)
          echo "ğŸ“Š 1. GraphQL APIë¡œ ì»¤ë°‹ ìˆ˜ í™•ì¸..."
          GRAPHQL_QUERY=$(cat <<'EOF'
          {
            "query": "query($username: String!, $from: DateTime!, $to: DateTime!) { user(login: $username) { contributionsCollection(from: $from, to: $to) { totalCommitContributions commitContributionsByRepository { repository { name owner { login } } contributions { totalCount } } } } }",
            "variables": {
              "username": "'"$USERNAME"'",
              "from": "'"$SINCE_DATE"'", 
              "to": "'"$UNTIL_DATE"'"
            }
          }
EOF
          )
          
          GRAPHQL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$GRAPHQL_QUERY" \
            "https://api.github.com/graphql")
          
          GRAPHQL_COUNT=$(echo "$GRAPHQL_RESPONSE" | jq --arg excluded "$EXCLUDED_REPOS" '
            .data.user.contributionsCollection.commitContributionsByRepository
            | map(select(.repository.name as $repo_name | ($excluded | split(",") | index($repo_name) | not)))
            | map(.contributions.totalCount)
            | add // 0
          ')
          
          echo "   GraphQL ê²°ê³¼: $GRAPHQL_COUNT ì»¤ë°‹"
          
          # ë°©ë²• 2: Search API (ê²€ì¦ìš©)
          echo "ğŸ” 2. Search APIë¡œ ê²€ì¦..."
          SEARCH_QUERY="author:$USERNAME committer-date:${WEEK_START}..${WEEK_END}"
          SEARCH_RESPONSE=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/search/commits?q=$(echo "$SEARCH_QUERY" | sed 's/ /%20/g')")
          
          SEARCH_COUNT=$(echo "$SEARCH_RESPONSE" | jq '.total_count // 0')
          echo "   Search API ê²°ê³¼: $SEARCH_COUNT ì»¤ë°‹"
          
          # ë°©ë²• 3: Events API (ê¸°ì¡´ ë°©ì‹, ë°±ì—…ìš©)
          echo "ğŸ“… 3. Events APIë¡œ ë°±ì—… í™•ì¸..."
          EVENTS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/users/$USERNAME/events?per_page=100")
          
          EVENTS_COUNT=$(echo "$EVENTS_RESPONSE" | jq --arg since_date "$SINCE_DATE" --arg until_date "$UNTIL_DATE" --arg excluded "$EXCLUDED_REPOS" '
            [
              .[] 
              | select(.type == "PushEvent") 
              | select((.created_at | fromdateiso8601) >= ($since_date | fromdateiso8601))
              | select((.created_at | fromdateiso8601) <= ($until_date | fromdateiso8601))
              | select(.repo.name | split("/")[1] as $repo_name | ($excluded | split(",") | index($repo_name) | not))
              | .payload.commits[]?
              | select(.author.name != "GitHub" and .author.name != "github-actions[bot]")
            ] 
            | length
          ')
          
          echo "   Events API ê²°ê³¼: $EVENTS_COUNT ì»¤ë°‹"
          
          # ìµœì¢… ì»¤ë°‹ ìˆ˜ ê²°ì • (ìš°ì„ ìˆœìœ„: GraphQL > Search > Events)
          if [ "$GRAPHQL_COUNT" != "null" ] && [ "$GRAPHQL_COUNT" != "0" ]; then
            FINAL_COUNT=$GRAPHQL_COUNT
            METHOD="GraphQL"
          elif [ "$SEARCH_COUNT" != "null" ] && [ "$SEARCH_COUNT" != "0" ]; then
            FINAL_COUNT=$SEARCH_COUNT  
            METHOD="Search"
          else
            FINAL_COUNT=$EVENTS_COUNT
            METHOD="Events"
          fi
          
          echo ""
          echo "ğŸ¯ ìµœì¢… ê²°ê³¼:"
          echo "   ì‚¬ìš©ëœ ë°©ë²•: $METHOD API"
          echo "   ì»¤ë°‹ ìˆ˜: $FINAL_COUNT"
          echo "   GraphQL: $GRAPHQL_COUNT | Search: $SEARCH_COUNT | Events: $EVENTS_COUNT"
          
          # ê²°ê³¼ê°€ ë‹¤ë¥´ë©´ ê²½ê³ 
          if [ "$GRAPHQL_COUNT" != "$SEARCH_COUNT" ] || [ "$SEARCH_COUNT" != "$EVENTS_COUNT" ]; then
            echo "âš ï¸ APIë³„ ê²°ê³¼ê°€ ë‹¤ë¦…ë‹ˆë‹¤. ê°€ì¥ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” GraphQL ê²°ê³¼ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
          fi
          
          echo "commit_count=$FINAL_COUNT" >> $GITHUB_OUTPUT
          echo "method_used=$METHOD" >> $GITHUB_OUTPUT
          echo "graphql_count=$GRAPHQL_COUNT" >> $GITHUB_OUTPUT
          echo "search_count=$SEARCH_COUNT" >> $GITHUB_OUTPUT  
          echo "events_count=$EVENTS_COUNT" >> $GITHUB_OUTPUT
          echo "period_start=$WEEK_START" >> $GITHUB_OUTPUT
          echo "period_end=$WEEK_END" >> $GITHUB_OUTPUT
