name: Weekly Commit Tracker

on:
  schedule:
    - cron: '0 * * * *'   # ë§¤ì‹œê°„ ì •ê° ì‹¤í–‰
  workflow_dispatch:

jobs:
  track-commits:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check weekly commits
        id: check_commits
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USERNAME="${{ github.repository_owner }}"
          NOW=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S')
          CURRENT_WEEKDAY=$(TZ='Asia/Seoul' date '+%u')
          
          echo "Current time (KST): $NOW"
          echo "Checking commits for user: $USERNAME"
          
          EXCLUDED_REPOS="weekly-commit-challenge"
          
          if [ "$CURRENT_WEEKDAY" -eq 1 ]; then
            # ì›”ìš”ì¼: ì§€ë‚œì£¼ ì›”ìš”ì¼~ì¼ìš”ì¼ (ì™„ë£Œëœ ì£¼)
            WEEK_START=$(TZ='Asia/Seoul' date -d '7 days ago' '+%Y-%m-%d')
            WEEK_END=$(TZ='Asia/Seoul' date -d '1 day ago' '+%Y-%m-%d')
            PERIOD_TYPE="ì§€ë‚œì£¼"
          else
            # í™”~ì¼ìš”ì¼: ì´ë²ˆì£¼ ì›”ìš”ì¼~ì˜¤ëŠ˜ (ì§„í–‰ì¤‘ì¸ ì£¼)
            DAYS_SINCE_MONDAY=$((CURRENT_WEEKDAY - 1))
            WEEK_START=$(TZ='Asia/Seoul' date -d "$DAYS_SINCE_MONDAY days ago" '+%Y-%m-%d')
            WEEK_END=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
            PERIOD_TYPE="ì´ë²ˆì£¼"
          fi
          
          echo "Week start: $WEEK_START, Week end: $WEEK_END"
          
          # í•œêµ­ ì‹œê°„ì„ UTCë¡œ ë³€í™˜ (KST - 9ì‹œê°„)
          SINCE_DATE_UTC=$(TZ='UTC' date -d "$WEEK_START 00:00:00 KST" -Iseconds)
          UNTIL_DATE_UTC=$(TZ='UTC' date -d "$WEEK_END 23:59:59 KST" -Iseconds)
          
          echo "KST Week start: $WEEK_START 00:00:00"
          echo "KST Week end: $WEEK_END 23:59:59"
          echo "UTC Since date: $SINCE_DATE_UTC"
          echo "UTC Until date: $UNTIL_DATE_UTC"
          
          # GraphQL ì¿¼ë¦¬ ìƒì„± (ìœ ì € ì •ë³´ì™€ ì»¤ë°‹ ì •ë³´ í•¨ê»˜ ì¡°íšŒ)
          echo '{"query":"query($username: String!, $from: DateTime!, $to: DateTime!) { user(login: $username) { avatarUrl contributionsCollection(from: $from, to: $to) { totalCommitContributions commitContributionsByRepository { repository { name owner { login } } contributions { totalCount } } } } }","variables":{"username":"'$USERNAME'","from":"'$SINCE_DATE_UTC'","to":"'$UNTIL_DATE_UTC'"}}' > /tmp/query.json
          
          # GraphQL API í˜¸ì¶œ
          GRAPHQL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d @/tmp/query.json \
            "https://api.github.com/graphql")
          
          echo "GraphQL Response: $GRAPHQL_RESPONSE"
          
          # ìœ ì € ì•„ë°”íƒ€ URL ì¶”ì¶œ
          AVATAR_URL=$(echo "$GRAPHQL_RESPONSE" | jq -r '.data.user.avatarUrl // ""')
          
          # ì»¤ë°‹ ìˆ˜ ê³„ì‚°
          COMMIT_COUNT=$(echo "$GRAPHQL_RESPONSE" | jq --arg excluded "$EXCLUDED_REPOS" '
            .data.user.contributionsCollection.commitContributionsByRepository
            | map(select(.repository.name as $repo_name | ($excluded | split(",") | index($repo_name) | not)))
            | map(.contributions.totalCount)
            | add // 0
          ')
          
          if [ -z "$COMMIT_COUNT" ] || [ "$COMMIT_COUNT" = "null" ]; then
            COMMIT_COUNT=0
          fi
          
          echo "Commit count: $COMMIT_COUNT"
          echo "Avatar URL: $AVATAR_URL"
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "period_start=$WEEK_START" >> $GITHUB_OUTPUT
          echo "period_end=$WEEK_END" >> $GITHUB_OUTPUT
          echo "period_type=$PERIOD_TYPE" >> $GITHUB_OUTPUT
          echo "avatar_url=$AVATAR_URL" >> $GITHUB_OUTPUT
          
          if [ $COMMIT_COUNT -gt 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate week number
        id: week_number
        run: |
          YEAR=$(TZ='Asia/Seoul' date '+%Y')
          WEEK_NUMBER=$(node -e "
            // í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì£¼ì°¨ ê³„ì‚°
            const now = new Date();
            const kstOffset = 9 * 60 * 60 * 1000; // 9ì‹œê°„ì„ ë°€ë¦¬ì´ˆë¡œ
            const kstNow = new Date(now.getTime() + kstOffset);
            
            const target = new Date(kstNow.valueOf());
            const dayNr = (target.getDay() + 6) % 7; // ì›”ìš”ì¼ì„ 0ìœ¼ë¡œ
            target.setDate(target.getDate() - dayNr + 3); // ëª©ìš”ì¼ë¡œ ì´ë™
            const jan4 = new Date(target.getFullYear(), 0, 4); // 1ì›” 4ì¼
            const dayDiff = (target - jan4) / 86400000;
            console.log(Math.ceil(dayDiff / 7));
          ")
          
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "Year: $YEAR, Week: $WEEK_NUMBER (KST ê¸°ì¤€)"

      - name: Check today commits (Monday only)
        id: check_today
        if: steps.check_commits.outputs.period_type == 'ì§€ë‚œì£¼'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USERNAME="${{ github.repository_owner }}"
          EXCLUDED_REPOS="weekly-commit-challenge"
          
          # ì˜¤ëŠ˜(ì›”ìš”ì¼) ë°ì´í„° ìˆ˜ì§‘
          TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          
          echo "Collecting today's commits: $TODAY"
          
          # í•œêµ­ ì‹œê°„ì„ UTCë¡œ ë³€í™˜
          SINCE_DATE_UTC=$(TZ='UTC' date -d "$TODAY 00:00:00 KST" -Iseconds)
          UNTIL_DATE_UTC=$(TZ='UTC' date -d "$TODAY 23:59:59 KST" -Iseconds)
          
          # GraphQL ì¿¼ë¦¬ ìƒì„±
          echo '{\"query\":\"query($username: String!, $from: DateTime!, $to: DateTime!) { user(login: $username) { avatarUrl contributionsCollection(from: $from, to: $to) { totalCommitContributions commitContributionsByRepository { repository { name owner { login } } contributions { totalCount } } } } }\",\"variables\":{\"username\":\"'$USERNAME'\",\"from\":\"'$SINCE_DATE_UTC'\",\"to\":\"'$UNTIL_DATE_UTC'\"}}' > /tmp/today_query.json
          
          # GraphQL API í˜¸ì¶œ
          GRAPHQL_RESPONSE=$(curl -s -X POST \
            -H \"Authorization: bearer $GITHUB_TOKEN\" \
            -H \"Content-Type: application/json\" \
            -d @/tmp/today_query.json \
            \"https://api.github.com/graphql\")
          
          # ì»¤ë°‹ ìˆ˜ ê³„ì‚°
          TODAY_COMMIT_COUNT=$(echo \"$GRAPHQL_RESPONSE\" | jq --arg excluded \"$EXCLUDED_REPOS\" '
            .data.user.contributionsCollection.commitContributionsByRepository
            | map(select(.repository.name as $repo_name | ($excluded | split(\",\") | index($repo_name) | not)))
            | map(.contributions.totalCount)
            | add // 0
          ')
          
          if [ -z \"$TODAY_COMMIT_COUNT\" ] || [ \"$TODAY_COMMIT_COUNT\" = \"null\" ]; then
            TODAY_COMMIT_COUNT=0
          fi
          
          echo "Today's commit count: $TODAY_COMMIT_COUNT"
          
          echo "today_commit_count=$TODAY_COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "today_date=$TODAY" >> $GITHUB_OUTPUT
          
          if [ $TODAY_COMMIT_COUNT -gt 0 ]; then
            echo "today_success=true" >> $GITHUB_OUTPUT
          else
            echo "today_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Initialize records for Fork users
        run: |
          USERNAME="${{ github.repository_owner }}"
          
          # Fork ì‚¬ìš©ìì¸ì§€ í™•ì¸ (ì›ë³¸ ì†Œìœ ìê°€ ì•„ë‹Œ ê²½ìš°)
          if [ "$USERNAME" != "tlqhrm" ]; then
            echo "ğŸ”„ Fork ì‚¬ìš©ì ($USERNAME) ê°ì§€ - ê¸°ë¡ ì´ˆê¸°í™” í™•ì¸ ì¤‘..."
            
            # ê¸°ì¡´ record.mdê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ í¬í•¨í•˜ê³  ìˆëŠ”ì§€ í™•ì¸
            NEEDS_INIT=false
            if [ -f record.md ]; then
              # record.md í—¤ë”ì—ì„œ ì‚¬ìš©ìëª… í™•ì¸
              HEADER_USER=$(grep "^# " record.md | head -1 | sed 's/# \(.*\) - Weekly Commit Challenge Record/\1/' | tr -d '\r\n')
              if [ -n "$HEADER_USER" ] && [ "$HEADER_USER" != "$USERNAME" ]; then
                echo "ğŸ“ ë‹¤ë¥¸ ì‚¬ìš©ì($HEADER_USER) ê¸°ë¡ ë°œê²¬ - $USERNAME ê¸°ë¡ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤"
                NEEDS_INIT=true
              elif grep -q "tlqhrm" record.md && [ "$USERNAME" != "tlqhrm" ]; then
                echo "ğŸ“ ì›ë³¸ ì‚¬ìš©ì ê¸°ë¡ ë°œê²¬ - $USERNAME ê¸°ë¡ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤"  
                NEEDS_INIT=true
              fi
            fi
            
            # record.jsonë„ í™•ì¸
            if [ -f record.json ]; then
              JSON_USER=$(cat record.json | grep -o '"username"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/"username"[[:space:]]*:[[:space:]]*"\([^"]*\)"/\1/')
              if [ -n "$JSON_USER" ] && [ "$JSON_USER" != "$USERNAME" ]; then
                echo "ğŸ“ record.jsonì—ì„œ ë‹¤ë¥¸ ì‚¬ìš©ì($JSON_USER) ê¸°ë¡ ë°œê²¬ - ì´ˆê¸°í™” í•„ìš”"
                NEEDS_INIT=true
              fi
            fi
            
            if [ "$NEEDS_INIT" = true ]; then
              
              # ìƒˆë¡œìš´ ë¹ˆ record.md ìƒì„±
              cat > record.md << EOF
          # $USERNAME - Weekly Commit Challenge Record
          
          ## ğŸ“Š ê¸°ë¡ í…Œì´ë¸”
          
          | ID | ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |
          | --- | --- | --- | --- | --- |
          EOF
              
              # ë¹ˆ record.json ìƒì„±
              cat > record.json << EOF
          {
            "username": "$USERNAME",
            "avatarUrl": "${{ steps.check_commits.outputs.avatar_url }}",
            "lastUpdated": "$(TZ='Asia/Seoul' date -Iseconds)",
            "records": []
          }
          EOF
              
              # statistics.jsonë„ ì´ˆê¸°í™” (Fork ì‚¬ìš©ììš©)
              cat > statistics.json << EOF
          {
            "lastUpdated": "$(TZ='Asia/Seoul' date -Iseconds)",
            "totalParticipants": 1,
            "activeParticipants": 0,
            "recordHolders": 0,
            "weeklySuccessful": 0,
            "averageStreak": 0,
            "averageSuccessRate": 0,
            "participants": [
              {
                "username": "$USERNAME",
                "avatarUrl": "${{ steps.check_commits.outputs.avatar_url }}",
                "lastPushed": "$(TZ='Asia/Seoul' date -Iseconds)",
                "currentStreak": 0,
                "maxStreak": 0,
                "totalWeeks": 0,
                "successRate": 0,
                "currentWeekSuccess": false
              }
            ],
            "rankingByStreak": [],
            "rankingBySuccessRate": [],
            "rankingByMaxStreak": []
          }
          EOF
              
              echo "âœ… $USERNAMEì„ ìœ„í•œ ìƒˆë¡œìš´ ê¸°ë¡ íŒŒì¼ ìƒì„± ì™„ë£Œ"
            else
              echo "â„¹ï¸ ì´ë¯¸ $USERNAMEì˜ ê¸°ë¡ì´ê±°ë‚˜ ì´ˆê¸°í™”ê°€ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤"
            fi
            
            # Fork ì‚¬ìš©ìì˜ statistics ì›Œí¬í”Œë¡œìš° ì œê±°
            if [ -f .github/workflows/collect-statistics.yml ]; then
              echo "ğŸ—‘ï¸ Fork ì‚¬ìš©ììš©ìœ¼ë¡œ statistics ì›Œí¬í”Œë¡œìš°ë¥¼ ì œê±°í•©ë‹ˆë‹¤"
              rm -f .github/workflows/collect-statistics.yml
              echo "âœ… collect-statistics.yml ì›Œí¬í”Œë¡œìš° ì œê±° ì™„ë£Œ"
            fi
          else
            echo "â„¹ï¸ ì›ë³¸ ë ˆí¬ì§€í† ë¦¬ - ì´ˆê¸°í™” ìŠ¤í‚µ"
          fi

      - name: Update record.md
        run: |
          COMMIT_COUNT="${{ steps.check_commits.outputs.commit_count }}"
          SUCCESS="${{ steps.check_commits.outputs.success }}"
          WEEK_NUM="${{ steps.week_number.outputs.week_number }}"
          PERIOD_START="${{ steps.check_commits.outputs.period_start }}"
          PERIOD_END="${{ steps.check_commits.outputs.period_end }}"
          PERIOD_TYPE="${{ steps.check_commits.outputs.period_type }}"
          YEAR=$(TZ='Asia/Seoul' date '+%Y')
          
          # ì£¼ì°¨ ê¸°ê°„ ê³„ì‚°
          START_DATE=$(TZ='Asia/Seoul' date -d "$PERIOD_START" '+%Y-%m-%d')
          START_WEEKDAY=$(TZ='Asia/Seoul' date -d "$START_DATE" '+%u')
          DAYS_TO_SUBTRACT=$((START_WEEKDAY - 1))
          MONDAY=$(TZ='Asia/Seoul' date -d "$START_DATE - $DAYS_TO_SUBTRACT days" '+%m/%d')
          SUNDAY=$(TZ='Asia/Seoul' date -d "$START_DATE - $DAYS_TO_SUBTRACT days + 6 days" '+%m/%d')
          WEEK_PERIOD="$MONDAY ~ $SUNDAY"
          
          if [ "$SUCCESS" = "true" ]; then
            STATUS_EMOJI="âœ… ì„±ê³µ"
          else
            STATUS_EMOJI="ğŸ”„ ì§„í–‰ì¤‘ ($COMMIT_COUNTê°œ)"
          fi
          
          # ì•„ë°”íƒ€ URL ê°€ì ¸ì˜¤ê¸°
          AVATAR_URL="${{ steps.check_commits.outputs.avatar_url }}"
          
          # ì›”ìš”ì¼ì¸ì§€ í™•ì¸
          if [ "$PERIOD_TYPE" = "ì§€ë‚œì£¼" ]; then
            # ì›”ìš”ì¼: ì§€ë‚œì£¼ + ì˜¤ëŠ˜ ë‘ ê°œì˜ ê¸°ë¡ ì²˜ë¦¬
            
            echo "ğŸ“Š ì›”ìš”ì¼ ì²˜ë¦¬: ì§€ë‚œì£¼ + ì´ë²ˆì£¼ ê¸°ë¡ ì¶”ê°€ (ì¤‘ë³µì€ ë‚˜ì¤‘ì— ì •ë¦¬)"
            
            # 1. ì§€ë‚œì£¼ ê¸°ë¡
            echo '{"period":"'$WEEK_PERIOD'","periodType":"ì§€ë‚œì£¼","dateRange":"'$PERIOD_START' ~ '$PERIOD_END'","year":'$YEAR',"weekNumber":'$WEEK_NUM',"commitCount":'$COMMIT_COUNT',"success":'$SUCCESS',"status":"'$STATUS_EMOJI'","lastUpdated":"'$(TZ='Asia/Seoul' date -Iseconds)'","username":"${{ github.repository_owner }}","avatarUrl":"'$AVATAR_URL'"}' > record_last_week.json
            
            # 2. ì˜¤ëŠ˜(ì´ë²ˆì£¼) ê¸°ë¡ 
            TODAY_COMMIT_COUNT="${{ steps.check_today.outputs.today_commit_count }}"
            TODAY_SUCCESS="${{ steps.check_today.outputs.today_success }}"
            TODAY_DATE="${{ steps.check_today.outputs.today_date }}"
            
            # ì´ë²ˆì£¼ ì£¼ì°¨ ê³„ì‚°
            THIS_WEEK_NUM=$((WEEK_NUM + 1))
            
            # ì´ë²ˆì£¼ ê¸°ê°„ ê³„ì‚° (ì›”ìš”ì¼~ì¼ìš”ì¼)
            THIS_MONDAY=$(TZ='Asia/Seoul' date '+%m/%d')
            THIS_SUNDAY=$(TZ='Asia/Seoul' date -d '+6 days' '+%m/%d')
            THIS_WEEK_PERIOD="$THIS_MONDAY ~ $THIS_SUNDAY"
            
            if [ "$TODAY_SUCCESS" = "true" ]; then
              TODAY_STATUS_EMOJI="âœ… ì„±ê³µ"
            else
              TODAY_STATUS_EMOJI="ğŸ”„ ì§„í–‰ì¤‘ ($TODAY_COMMIT_COUNTê°œ)"
            fi
            
            # record.jsonì— ì „ì²´ ê¸°ë¡ í¬í•¨
            {
              echo '{'
              echo '  "username": "${{ github.repository_owner }}",'
              echo '  "avatarUrl": "'$AVATAR_URL'",'
              echo '  "lastUpdated": "'$(TZ='Asia/Seoul' date -Iseconds)'",'
              echo '  "records": ['
              
              # ê¸°ì¡´ ê¸°ë¡ë“¤ ì¶”ê°€
              if [ -f record.md.bak ]; then
                first_record=true
                while IFS= read -r line; do
                  if [[ "$line" == "|"*"|"*"|"*"|"* && "$line" != *"ê¸°ê°„"* && "$line" != *"---"* ]]; then
                    parts=($(echo "$line" | tr '|' ' '))
                    # ID ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸ (5ê°œ ì»¬ëŸ¼ì´ë©´ ID ìˆìŒ, 4ê°œë©´ ì—†ìŒ)
                    if [ ${#parts[@]} -eq 6 ]; then
                      # ID í¬í•¨ (| ID | ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |)
                      period="${parts[2]// /}"
                      week="${parts[3]// /}"
                      commits="${parts[4]// /}"
                      status="${parts[5]// /}"
                    else
                      # ID ì—†ìŒ (| ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |)
                      period="${parts[1]// /}"
                      week="${parts[2]// /}"
                      commits="${parts[3]// /}"
                      status="${parts[4]// /}"
                    fi
                    
                    if [ "$first_record" = false ]; then echo '    ,'; fi
                    success="false"
                    if [[ "$status" == *"âœ…"* && "$status" != *"ğŸ”„"* ]]; then
                      success="true"
                    fi
                    echo '    {'
                    echo '      "period": "'$period'",'
                    echo '      "week": "'$week'",'
                    echo '      "commits": '$commits','
                    echo '      "success": '$success','
                    echo '      "status": "'$status'"'
                    echo -n '    }'
                    first_record=false
                  fi
                done < record.md.bak
                if [ "$first_record" = false ]; then echo ','; fi
              fi
              
              # ì§€ë‚œì£¼ ê¸°ë¡ ì¶”ê°€
              echo '    {'
              echo '      "period": "'$WEEK_PERIOD'",'
              echo '      "week": "'${YEAR}ë…„ ${WEEK_NUM}ì£¼ì°¨'",'
              echo '      "commits": '$COMMIT_COUNT','
              echo '      "success": '$SUCCESS','
              echo '      "status": "'$STATUS_EMOJI'"'
              echo '    },'
              
              # ì´ë²ˆì£¼ ê¸°ë¡ ì¶”ê°€
              echo '    {'
              echo '      "period": "'$THIS_WEEK_PERIOD'",'
              echo '      "week": "'${YEAR}ë…„ ${THIS_WEEK_NUM}ì£¼ì°¨'",'
              echo '      "commits": '$TODAY_COMMIT_COUNT','
              echo '      "success": '$TODAY_SUCCESS','
              echo '      "status": "'$TODAY_STATUS_EMOJI'"'
              echo '    }'
              echo '  ]'
              echo '}'
            } > record.json
            
            # ê¸°ì¡´ record.md ë°±ì—…
            if [ -f record.md ]; then
              cp record.md record.md.bak
            fi
            
            # record.mdì— ë‘ ê¸°ë¡ ëª¨ë‘ í¬í•¨ (ì˜¤ë¦„ì°¨ìˆœ: ì˜¤ë˜ëœ ê²ƒì´ ìœ„ë¡œ)
            {
              echo "# ${{ github.repository_owner }} - Weekly Commit Challenge Record"
              echo ""
              echo "## ğŸ“Š ê¸°ë¡ í…Œì´ë¸”"
              echo ""
              echo "| ID | ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |"
              echo "| --- | --- | --- | --- | --- |"
            } > record.md
            
            # ê¸°ì¡´ ê¸°ë¡ì´ ìˆë‹¤ë©´ ì¶”ê°€ (ì˜¤ë¦„ì°¨ìˆœ ìœ ì§€)
            NEXT_ID=1
            if [ -f record.md.bak ]; then
              # ê¸°ì¡´ ë°ì´í„° ì¶”ì¶œí•˜ì—¬ ì¶”ê°€ (ID í¬í•¨)
              while IFS= read -r line; do
                if [[ "$line" == "|"*"|"*"|"*"|"* && "$line" != *"ID"* && "$line" != *"---"* ]]; then
                  parts=($(echo "$line" | tr '|' ' '))
                  # ID ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
                  if [ ${#parts[@]} -eq 6 ]; then
                    # ID ì´ë¯¸ ìˆìŒ - ìƒˆ IDë¡œ êµì²´
                    period="${parts[2]// /}"
                    week="${parts[3]// /}"
                    commits="${parts[4]// /}"
                    status="${parts[5]// /}"
                  else
                    # ID ì—†ìŒ - ì¶”ê°€
                    period="${parts[1]// /}"
                    week="${parts[2]// /}"
                    commits="${parts[3]// /}"
                    status="${parts[4]// /}"
                  fi
                  
                  
                  echo "| $NEXT_ID | $period | $week | $commits | $status |" >> record.md
                  NEXT_ID=$((NEXT_ID + 1))
                fi
              done < <(grep "^|.*|.*|.*|.*" record.md.bak | grep -v "ID\|---" || true)
            fi
            
            # ìƒˆ ê¸°ë¡ë“¤ ì¶”ê°€ (ì§€ë‚œì£¼ ë¨¼ì €, ì´ë²ˆì£¼ ë‚˜ì¤‘ì—)
            echo "| $NEXT_ID | $WEEK_PERIOD | ${YEAR}ë…„ ${WEEK_NUM}ì£¼ì°¨ | $COMMIT_COUNT | $STATUS_EMOJI |" >> record.md
            NEXT_ID=$((NEXT_ID + 1))
            echo "| $NEXT_ID | $THIS_WEEK_PERIOD | ${YEAR}ë…„ ${THIS_WEEK_NUM}ì£¼ì°¨ | $TODAY_COMMIT_COUNT | $TODAY_STATUS_EMOJI |" >> record.md
            
          else
            # í™”~ì¼ìš”ì¼: ì´ë²ˆì£¼ ê¸°ë¡ ì¶”ê°€ (ì¤‘ë³µì€ ë‚˜ì¤‘ì— ì •ë¦¬)
            {
              echo '{'
              echo '  "username": "${{ github.repository_owner }}",'
              echo '  "avatarUrl": "'$AVATAR_URL'",'
              echo '  "lastUpdated": "'$(TZ='Asia/Seoul' date -Iseconds)'",'
              echo '  "records": ['
              
              # ê¸°ì¡´ ê¸°ë¡ë“¤ ì¶”ê°€
              if [ -f record.md.bak ]; then
                first_record=true
                while IFS= read -r line; do
                  if [[ "$line" == "|"*"|"*"|"*"|"* && "$line" != *"ê¸°ê°„"* && "$line" != *"---"* ]]; then
                    if [ "$first_record" = false ]; then echo '    ,'; fi
                    parts=($(echo "$line" | tr '|' ' '))
                    # ID ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸ (5ê°œ ì»¬ëŸ¼ì´ë©´ ID ìˆìŒ, 4ê°œë©´ ì—†ìŒ)
                    if [ ${#parts[@]} -eq 6 ]; then
                      # ID í¬í•¨ (| ID | ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |)
                      period="${parts[2]// /}"
                      week="${parts[3]// /}"
                      commits="${parts[4]// /}"
                      status="${parts[5]// /}"
                    else
                      # ID ì—†ìŒ (| ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |)
                      period="${parts[1]// /}"
                      week="${parts[2]// /}"
                      commits="${parts[3]// /}"
                      status="${parts[4]// /}"
                    fi
                    success="false"
                    if [[ "$status" == *"âœ…"* && "$status" != *"ğŸ”„"* ]]; then
                      success="true"
                    fi
                    echo '    {'
                    echo '      "period": "'$period'",'
                    echo '      "week": "'$week'",'
                    echo '      "commits": '$commits','
                    echo '      "success": '$success','
                    echo '      "status": "'$status'"'
                    echo -n '    }'
                    first_record=false
                  fi
                done < record.md.bak
                if [ "$first_record" = false ]; then echo ','; fi
              fi
              
              # í˜„ì¬ ê¸°ë¡ ì¶”ê°€ (í•­ìƒ ë§ˆì§€ë§‰ì—)
              echo '    {'
              echo '      "period": "'$WEEK_PERIOD'",'
              echo '      "week": "'${YEAR}ë…„ ${WEEK_NUM}ì£¼ì°¨'",'
              echo '      "commits": '$COMMIT_COUNT','
              echo '      "success": '$SUCCESS','
              echo '      "status": "'$STATUS_EMOJI'"'
              echo '    }'
              echo '  ]'
              echo '}'
            } > record.json
            
            # ê¸°ì¡´ record.md ë°±ì—…
            if [ -f record.md ]; then
              cp record.md record.md.bak
            fi
            
            {
              echo "# ${{ github.repository_owner }} - Weekly Commit Challenge Record"
              echo ""
              echo "## ğŸ“Š ê¸°ë¡ í…Œì´ë¸”"
              echo ""
              echo "| ID | ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |"
              echo "| --- | --- | --- | --- | --- |"
            } > record.md
            
            # ê¸°ì¡´ ê¸°ë¡ì´ ìˆë‹¤ë©´ ì¶”ê°€ (ì˜¤ë¦„ì°¨ìˆœ ìœ ì§€)
            NEXT_ID=1
            if [ -f record.md.bak ]; then
              # ê¸°ì¡´ ë°ì´í„° ì¶”ì¶œí•˜ì—¬ ì¶”ê°€ (ID í¬í•¨)
              while IFS= read -r line; do
                if [[ "$line" == "|"*"|"*"|"*"|"* && "$line" != *"ID"* && "$line" != *"---"* ]]; then
                  parts=($(echo "$line" | tr '|' ' '))
                  # ID ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
                  if [ ${#parts[@]} -eq 6 ]; then
                    # ID ì´ë¯¸ ìˆìŒ - ìƒˆ IDë¡œ êµì²´
                    period="${parts[2]// /}"
                    week="${parts[3]// /}"
                    commits="${parts[4]// /}"
                    status="${parts[5]// /}"
                  else
                    # ID ì—†ìŒ - ì¶”ê°€
                    period="${parts[1]// /}"
                    week="${parts[2]// /}"
                    commits="${parts[3]// /}"
                    status="${parts[4]// /}"
                  fi
                  echo "| $NEXT_ID | $period | $week | $commits | $status |" >> record.md
                  NEXT_ID=$((NEXT_ID + 1))
                fi
              done < <(grep "^|.*|.*|.*|.*" record.md.bak | grep -v "ID\|---" || true)
            fi
            
            # ìƒˆ ê¸°ë¡ ì¶”ê°€
            echo "| $NEXT_ID | $WEEK_PERIOD | ${YEAR}ë…„ ${WEEK_NUM}ì£¼ì°¨ | $COMMIT_COUNT | $STATUS_EMOJI |" >> record.md
          fi

      - name: Cleanup duplicates
        run: |
          echo "ğŸ”§ ì¤‘ë³µ ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
          chmod +x ./cleanup-duplicates.sh
          ./cleanup-duplicates.sh

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ëª¨ë“  ë³€ê²½ì‚¬í•­ ì¶”ê°€ (ì‚­ì œëœ íŒŒì¼ í¬í•¨)
          git add -A
          
          # ì›”ìš”ì¼ì¸ ê²½ìš° ì¶”ê°€ íŒŒì¼ë„ í¬í•¨
          if [ "${{ steps.check_commits.outputs.period_type }}" = "ì§€ë‚œì£¼" ]; then
            git add record.md record.json record_last_week.json
          else
            git add record.md record.json
          fi
          
          if ! git diff --staged --quiet; then
            CURRENT_TIME=$(TZ='Asia/Seoul' date '+%m/%d %H:%M')
            PERIOD_TYPE="${{ steps.check_commits.outputs.period_type }}"
            if [ "$PERIOD_TYPE" = "ì§€ë‚œì£¼" ]; then
              git commit -m "ğŸ“Š ${{ steps.week_number.outputs.week_number }}ì£¼ì°¨ ìœ„í´ë¦¬ ì»¤ë°‹ ì±Œë¦°ì§€ ê¸°ë¡ ì—…ë°ì´íŠ¸ (ì›”ìš”ì¼: ì§€ë‚œì£¼+ì´ë²ˆì£¼) ($CURRENT_TIME)"
            else
              git commit -m "ğŸ“Š ${{ steps.week_number.outputs.week_number }}ì£¼ì°¨ ìœ„í´ë¦¬ ì»¤ë°‹ ì±Œë¦°ì§€ ê¸°ë¡ ì—…ë°ì´íŠ¸ ($CURRENT_TIME)"
            fi
            git push
            echo "âœ… ê¸°ë¡ íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi
