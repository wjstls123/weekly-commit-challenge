name: Weekly Commit Tracker

on:
  schedule:
    - cron: '55 * * * *'   # ë§¤ì‹œê°„ 55ë¶„ ì‹¤í–‰
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: weekly-commit-${{ github.repository }}
  cancel-in-progress: false

jobs:
  track-commits:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Get current time and week info
        id: time_info
        run: |
          # í•œêµ­ ì‹œê°„ ê¸°ì¤€ í˜„ì¬ ì‹œê°
          CURRENT_DATE_KST=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          CURRENT_WEEKDAY=$(TZ='Asia/Seoul' date '+%u')  # 1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼
          CURRENT_TIME_KST=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S')
          
          echo "current_date=$CURRENT_DATE_KST" >> $GITHUB_OUTPUT
          echo "current_weekday=$CURRENT_WEEKDAY" >> $GITHUB_OUTPUT
          echo "current_time=$CURRENT_TIME_KST" >> $GITHUB_OUTPUT
          
          echo "ğŸ“… í˜„ì¬ ì‹œê° (KST): $CURRENT_TIME_KST"
          echo "ğŸ“… í˜„ì¬ ìš”ì¼: $CURRENT_WEEKDAY (1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼)"

      - name: Calculate current week range
        id: week_range
        run: |
          CURRENT_DATE="${{ steps.time_info.outputs.current_date }}"
          CURRENT_WEEKDAY="${{ steps.time_info.outputs.current_weekday }}"
          
          # ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ê³„ì‚°
          DAYS_TO_MONDAY=$((CURRENT_WEEKDAY - 1))
          WEEK_START=$(TZ='Asia/Seoul' date -d "$CURRENT_DATE - $DAYS_TO_MONDAY days" '+%Y-%m-%d')
          
          # ì´ë²ˆ ì£¼ ì¼ìš”ì¼ ê³„ì‚°
          DAYS_TO_SUNDAY=$((7 - CURRENT_WEEKDAY))
          WEEK_END=$(TZ='Asia/Seoul' date -d "$CURRENT_DATE + $DAYS_TO_SUNDAY days" '+%Y-%m-%d')
          
          # ì£¼ì°¨ ë²ˆí˜¸ ê³„ì‚° (ISO 8601 ê¸°ì¤€)
          WEEK_NUMBER=$(node -e "
            const date = new Date('$CURRENT_DATE');
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const jan4 = new Date(target.getFullYear(), 0, 4);
            const dayDiff = (target - jan4) / 86400000;
            console.log(1 + Math.floor(dayDiff / 7));
          ")
          
          YEAR=$(TZ='Asia/Seoul' date '+%Y')
          
          echo "week_start=$WEEK_START" >> $GITHUB_OUTPUT
          echo "week_end=$WEEK_END" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ì´ë²ˆ ì£¼: $WEEK_START ~ $WEEK_END (${YEAR}ë…„ ${WEEK_NUMBER}ì£¼ì°¨)"

      - name: Initialize Fork user records (early)
        if: github.repository_owner != 'tlqhrm'
        run: |
          USERNAME="${{ github.repository_owner }}"
          
          echo "ğŸ”„ Fork ì‚¬ìš©ì ($USERNAME) ê°ì§€ - ì¡°ê¸° ì´ˆê¸°í™”"
          
          # Fork ì‚¬ìš©ì ì´ˆê¸°í™” ì²˜ë¦¬
          if [ -f record.json ]; then
            EXISTING_USERNAME=$(cat record.json | jq -r '.username // empty' 2>/dev/null || echo "empty")
            
            if [ "$EXISTING_USERNAME" != "$USERNAME" ] && [ "$EXISTING_USERNAME" != "empty" ]; then
              echo "âš ï¸ ë‹¤ë¥¸ ì‚¬ìš©ì($EXISTING_USERNAME)ì˜ ê¸°ë¡ ë°œê²¬ - ì™„ì „ ì´ˆê¸°í™”"
              rm -f record.json record.md
              echo "âœ… ê¸°ì¡´ ê¸°ë¡ ì™„ì „ ì´ˆê¸°í™” ì™„ë£Œ"
            fi
          fi
          
          # statistics ì›Œí¬í”Œë¡œìš° ì œê±°
          if [ -f .github/workflows/collect-statistics.yml ]; then
            rm -f .github/workflows/collect-statistics.yml
            echo "âœ… collect-statistics.yml ì›Œí¬í”Œë¡œìš° ì œê±° ì™„ë£Œ"
          fi

      - name: Check existing records
        id: existing_records
        run: |
          USERNAME="${{ github.repository_owner }}"
          
          # record.json íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -f record.json ]; then
            echo "ğŸ“‹ ê¸°ì¡´ record.json ë°œê²¬"
            
            # ë§ˆì§€ë§‰ ê¸°ë¡ì˜ ì£¼ì°¨ ì •ë³´ ì¶”ì¶œ
            LAST_WEEK_START=$(cat record.json | jq -r '.records[-1].weekStart // empty')
            LAST_WEEK_END=$(cat record.json | jq -r '.records[-1].weekEnd // empty')
            RECORD_COUNT=$(cat record.json | jq '.records | length')
            
            echo "last_week_start=$LAST_WEEK_START" >> $GITHUB_OUTPUT
            echo "last_week_end=$LAST_WEEK_END" >> $GITHUB_OUTPUT
            echo "record_count=$RECORD_COUNT" >> $GITHUB_OUTPUT
            echo "has_records=true" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š ê¸°ì¡´ ê¸°ë¡: $RECORD_COUNTê°œ, ë§ˆì§€ë§‰ ì£¼: $LAST_WEEK_START ~ $LAST_WEEK_END"
          else
            echo "ğŸ“‹ ê¸°ì¡´ ê¸°ë¡ ì—†ìŒ - ì²« ë²ˆì§¸ ê¸°ë¡ ìƒì„± ì˜ˆì •"
            echo "last_week_start=" >> $GITHUB_OUTPUT
            echo "last_week_end=" >> $GITHUB_OUTPUT
            echo "record_count=0" >> $GITHUB_OUTPUT
            echo "has_records=false" >> $GITHUB_OUTPUT
          fi

      - name: Check skip conditions
        id: skip_check
        run: |
          CURRENT_WEEKDAY="${{ steps.time_info.outputs.current_weekday }}"
          CURRENT_HOUR=$(TZ='Asia/Seoul' date '+%H')
          
          echo "â–¶ï¸ ì •ìƒ ì‹¤í–‰ - ìŠ¤í‚µ ë¡œì§ ì œê±°"
          echo "should_skip=false" >> $GITHUB_OUTPUT

      - name: Check if new record needed
        id: should_add_record
        if: steps.skip_check.outputs.should_skip == 'false'
        run: |
          # í…ŒìŠ¤íŠ¸ëœ ë¡œì§ ì ìš© (ë‹¨ìˆœí™”)
          CURRENT_WEEK_START="${{ steps.week_range.outputs.week_start }}"
          LAST_WEEK_START="${{ steps.existing_records.outputs.last_week_start }}"
          LAST_WEEK_END="${{ steps.existing_records.outputs.last_week_end }}"
          HAS_RECORDS="${{ steps.existing_records.outputs.has_records }}"
          CURRENT_DATE="${{ steps.time_info.outputs.current_date }}"
          
          echo "ğŸ” ìƒˆ ê¸°ë¡ ì¶”ê°€ í•„ìš”ì„± ê²€ì‚¬..."
          echo "í˜„ì¬ ì£¼ ì‹œì‘: $CURRENT_WEEK_START"
          echo "ë§ˆì§€ë§‰ ê¸°ë¡ ì£¼ ì‹œì‘: $LAST_WEEK_START"
          echo "ë§ˆì§€ë§‰ ê¸°ë¡ ì£¼ ì¢…ë£Œ: $LAST_WEEK_END"
          
          # 1. ì²« ë²ˆì§¸ ê¸°ë¡ì´ë©´ ë¬´ì¡°ê±´ ì¶”ê°€
          if [ "$HAS_RECORDS" = "false" ]; then
            echo "âœ… ì²« ë²ˆì§¸ ê¸°ë¡ - ì¶”ê°€ í•„ìš”"
            echo "should_add=true" >> $GITHUB_OUTPUT
            echo "reason=ì²« ë²ˆì§¸ ê¸°ë¡" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 2. ìƒˆë¡œìš´ ì£¼ì¸ì§€ í™•ì¸
          if [ "$CURRENT_DATE" \> "$LAST_WEEK_END" ]; then
            IS_NEW_WEEK=true
            echo "ìƒˆë¡œìš´ ì£¼: true (í˜„ì¬: $CURRENT_DATE > ë§ˆì§€ë§‰ ì¢…ë£Œ: $LAST_WEEK_END)"
          else
            IS_NEW_WEEK=false
            echo "ìƒˆë¡œìš´ ì£¼: false (í˜„ì¬: $CURRENT_DATE <= ë§ˆì§€ë§‰ ì¢…ë£Œ: $LAST_WEEK_END)"
          fi
          
          # 3. ê°™ì€ ì£¼ ê¸°ë¡ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ "$CURRENT_WEEK_START" = "$LAST_WEEK_START" ]; then
            IS_SAME_WEEK=true
            echo "ê°™ì€ ì£¼ ê¸°ë¡ ì¡´ì¬: true (í˜„ì¬ ì‹œì‘: $CURRENT_WEEK_START = ë§ˆì§€ë§‰ ì‹œì‘: $LAST_WEEK_START)"
          else
            IS_SAME_WEEK=false
            echo "ê°™ì€ ì£¼ ê¸°ë¡ ì¡´ì¬: false (í˜„ì¬ ì‹œì‘: $CURRENT_WEEK_START != ë§ˆì§€ë§‰ ì‹œì‘: $LAST_WEEK_START)"
          fi
          
          # 4. ìµœì¢… íŒë‹¨: ìƒˆë¡œìš´ ì£¼ì´ê³  ê°™ì€ ì£¼ ê¸°ë¡ì´ ì—†ì„ ë•Œë§Œ ì¶”ê°€
          if [ "$IS_NEW_WEEK" = true ] && [ "$IS_SAME_WEEK" = false ]; then
            echo "âœ… ìƒˆ ê¸°ë¡ ì¶”ê°€ í•„ìš” (ìƒˆ ì£¼: $IS_NEW_WEEK, ê°™ì€ ì£¼ ê¸°ë¡ ì—†ìŒ: $([ "$IS_SAME_WEEK" = false ] && echo true || echo false))"
            echo "should_add=true" >> $GITHUB_OUTPUT
            echo "reason=ìƒˆë¡œìš´ ì£¼ ì‹œì‘" >> $GITHUB_OUTPUT
          else
            echo "âŒ ìƒˆ ê¸°ë¡ ì¶”ê°€ ë¶ˆí•„ìš” (ìƒˆ ì£¼: $IS_NEW_WEEK, ê°™ì€ ì£¼ ê¸°ë¡ ì—†ìŒ: $([ "$IS_SAME_WEEK" = false ] && echo true || echo false))"
            echo "should_add=false" >> $GITHUB_OUTPUT
            echo "reason=ê¸°ì¡´ ì£¼ ì—…ë°ì´íŠ¸" >> $GITHUB_OUTPUT
          fi

      - name: Get user info and commits
        id: get_commits
        if: steps.skip_check.outputs.should_skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
          USERNAME="${{ github.repository_owner }}"
          WEEK_START="${{ steps.week_range.outputs.week_start }}"
          WEEK_END="${{ steps.week_range.outputs.week_end }}"
          EXCLUDED_REPOS="weekly-commit-challenge"
          
          echo "ğŸ‘¤ ì‚¬ìš©ì: $USERNAME"
          echo "ğŸ“… ì¡°íšŒ ê¸°ê°„: $WEEK_START ~ $WEEK_END"
          
          # í•œêµ­ ì‹œê°„ì„ UTCë¡œ ë³€í™˜
          SINCE_UTC=$(TZ='UTC' date -d "$WEEK_START 00:00:00 KST" -Iseconds)
          UNTIL_UTC=$(TZ='UTC' date -d "$WEEK_END 23:59:59 KST" -Iseconds)
          
          echo "ğŸŒ UTC ì¡°íšŒ ê¸°ê°„: $SINCE_UTC ~ $UNTIL_UTC"
          
          # GraphQL ì¿¼ë¦¬ ìƒì„±
          cat > query.json << EOF
          {
            "query": "query(\$username: String!, \$from: DateTime!, \$to: DateTime!) { user(login: \$username) { avatarUrl contributionsCollection(from: \$from, to: \$to) { totalCommitContributions commitContributionsByRepository { repository { name owner { login } } contributions { totalCount } } } } }",
            "variables": {
              "username": "$USERNAME",
              "from": "$SINCE_UTC",
              "to": "$UNTIL_UTC"
            }
          }
          EOF
          
          # GraphQL API í˜¸ì¶œ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
          for i in {1..3}; do
            echo "ğŸ“¡ GraphQL API í˜¸ì¶œ ì‹œë„ $i/3"
            RESPONSE=$(curl -s -X POST \
              -H "Authorization: bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d @query.json \
              "https://api.github.com/graphql")
            
            # API ì‘ë‹µ ìœ íš¨ì„± ê²€ì‚¬
            if echo "$RESPONSE" | jq -e '.data' >/dev/null 2>&1; then
              echo "âœ… GraphQL API ì‘ë‹µ ì„±ê³µ"
              echo "ğŸ“¡ GraphQL ì‘ë‹µ: $RESPONSE"
              break
            elif [ $i -eq 3 ]; then
              echo "âŒ GraphQL API í˜¸ì¶œ ì‹¤íŒ¨ (3íšŒ ì‹œë„ í›„): $RESPONSE"
              echo "avatar_url=" >> $GITHUB_OUTPUT
              echo "commit_count=0" >> $GITHUB_OUTPUT
              echo "user_exists=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "âš ï¸ GraphQL API í˜¸ì¶œ ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘... ($RESPONSE)"
              sleep 2
            fi
          done
          
          # ì‚¬ìš©ì ì¡´ì¬ í™•ì¸
          USER_EXISTS=$(echo "$RESPONSE" | jq -r '.data.user // null')
          if [ "$USER_EXISTS" = "null" ]; then
            echo "âŒ ì‚¬ìš©ì '$USERNAME'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "avatar_url=" >> $GITHUB_OUTPUT
            echo "commit_count=0" >> $GITHUB_OUTPUT
            echo "user_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ì•„ë°”íƒ€ URL ì¶”ì¶œ
          AVATAR_URL=$(echo "$RESPONSE" | jq -r '.data.user.avatarUrl // ""')
          
          # ì»¤ë°‹ ìˆ˜ ê³„ì‚° (ì œì™¸í•  ì €ì¥ì†Œ í•„í„°ë§)
          COMMIT_COUNT=$(echo "$RESPONSE" | jq --arg excluded "$EXCLUDED_REPOS" '
            .data.user.contributionsCollection.commitContributionsByRepository
            | map(select(.repository.name as $repo_name | ($excluded | split(",") | index($repo_name) | not)))
            | map(.contributions.totalCount)
            | add // 0
          ')
          
          echo "ğŸ‘¤ ì•„ë°”íƒ€ URL: $AVATAR_URL"
          echo "ğŸ“Š ì»¤ë°‹ ìˆ˜: $COMMIT_COUNT"
          
          echo "avatar_url=$AVATAR_URL" >> $GITHUB_OUTPUT
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "user_exists=true" >> $GITHUB_OUTPUT

      - name: Remove duplicates from existing records
        if: steps.skip_check.outputs.should_skip == 'false' && steps.existing_records.outputs.has_records == 'true'
        run: |
          echo "ğŸ§¹ ê¸°ì¡´ ê¸°ë¡ ì¤‘ë³µ ì œê±° ë° ì •ê·œí™” ì¤‘..."
          
          if [ -f record.json ]; then
            # ì›ë³¸ ê°œìˆ˜ í™•ì¸
            ORIGINAL_COUNT=$(cat record.json | jq '.records | length' 2>/dev/null || echo "0")
            echo "ğŸ“Š ì›ë³¸ ê¸°ë¡ ìˆ˜: $ORIGINAL_COUNTê°œ"
            
            # ì¤‘ë³µ ì œê±° ë° ì •ê·œí™”
            CLEANED_RECORDS=$(cat record.json | jq --arg username "${{ github.repository_owner }}" '
              # 1. ê¸°ë³¸ êµ¬ì¡° ë³´ì¥
              .username = $username |
              .records = (.records // []) |
              
              # 2. ê° ê¸°ë¡ì˜ í•„ìˆ˜ í•„ë“œ ì •ê·œí™”
              .records |= map(
                # weekStartê°€ ì—†ìœ¼ë©´ periodë¥¼ í‚¤ë¡œ ì‚¬ìš©
                if .weekStart and .weekStart != "" then
                  .
                else
                  . + {"weekStart": (.period // ""), "weekEnd": (.period // "")}
                end |
                
                # í•„ìˆ˜ í•„ë“œ ë³´ì¥ (IDê°€ 0ì´ë©´ ì„ì‹œë¡œ í° ìˆ˜ í• ë‹¹)
                .id = (if .id and .id > 0 then .id else 9999 end) |
                .commits = (.commits // 0) |
                .success = (.success // (.commits > 0)) |
                .status = (.status // (if .commits > 0 then "âœ… ì„±ê³µ" else "âŒ ì‹¤íŒ¨" end))
              ) |
              
              # 3. period ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ì œê±° (ë” í™•ì‹¤í•œ ë°©ë²•)
              .records |= (
                group_by(.period) |
                map(
                  # ê°™ì€ ê·¸ë£¹ì—ì„œ IDê°€ ê°€ì¥ í° ê²ƒ ì„ íƒ, weekStartê°€ ìˆëŠ” ê²ƒ ìš°ì„ 
                  max_by([(.weekStart != "" and .weekStart != null), .id // 0])
                ) |
                sort_by(.id // 0)
              ) |
              
              # 4. ID ì¬ì •ë ¬ (1ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ)
              .records |= (
                to_entries |
                map(.value.id = (.key + 1)) |
                map(.value)
              )
            ')
            
            # ê²°ê³¼ í™•ì¸
            CLEANED_COUNT=$(echo "$CLEANED_RECORDS" | jq '.records | length')
            echo "ğŸ” ì •ë¦¬ í›„ ê¸°ë¡ ìˆ˜: $CLEANED_COUNTê°œ"
            
            # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ íŒŒì¼ ì—…ë°ì´íŠ¸
            if [ "$ORIGINAL_COUNT" != "$CLEANED_COUNT" ] || ! echo "$CLEANED_RECORDS" | jq -e '. == '"$(cat record.json)"'' >/dev/null 2>&1; then
              echo "$CLEANED_RECORDS" > record.json
              echo "âœ… ì¤‘ë³µ ì œê±° ë° ì •ê·œí™” ì™„ë£Œ: $ORIGINAL_COUNTê°œ â†’ $CLEANED_COUNTê°œ"
            else
              echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ ($ORIGINAL_COUNTê°œ ìœ ì§€)"
            fi
          fi

      - name: Update or create record
        if: steps.skip_check.outputs.should_skip == 'false' && (steps.should_add_record.outputs.should_add == 'true' || steps.existing_records.outputs.has_records == 'true')
        run: |
          USERNAME="${{ github.repository_owner }}"
          AVATAR_URL="${{ steps.get_commits.outputs.avatar_url }}"
          COMMIT_COUNT="${{ steps.get_commits.outputs.commit_count }}"
          WEEK_START="${{ steps.week_range.outputs.week_start }}"
          WEEK_END="${{ steps.week_range.outputs.week_end }}"
          WEEK_NUMBER="${{ steps.week_range.outputs.week_number }}"
          YEAR="${{ steps.week_range.outputs.year }}"
          SHOULD_ADD="${{ steps.should_add_record.outputs.should_add }}"
          REASON="${{ steps.should_add_record.outputs.reason }}"
          
          # ì„±ê³µ ì—¬ë¶€ íŒë‹¨
          if [ $COMMIT_COUNT -gt 0 ]; then
            SUCCESS="true"
            STATUS="âœ… ì„±ê³µ"
          else
            SUCCESS="false"
            STATUS="âŒ ì‹¤íŒ¨"
          fi
          
          # ì£¼ì°¨ ê¸°ê°„ í‘œì‹œ í˜•ì‹ (MM/DD)
          PERIOD_START=$(TZ='Asia/Seoul' date -d "$WEEK_START" '+%m/%d')
          PERIOD_END=$(TZ='Asia/Seoul' date -d "$WEEK_END" '+%m/%d')
          PERIOD="$PERIOD_START ~ $PERIOD_END"
          
          echo "ğŸ“ ê¸°ë¡ ì—…ë°ì´íŠ¸ ì¤‘..."
          echo "ì‚¬ìœ : $REASON"
          echo "ê¸°ê°„: $PERIOD (${YEAR}ë…„ ${WEEK_NUMBER}ì£¼ì°¨)"
          echo "ì»¤ë°‹: $COMMIT_COUNTê°œ ($STATUS)"
          
          # ID ë¯¸ë¦¬ ê³„ì‚°
          if [ "$SHOULD_ADD" = "true" ]; then
            # ìƒˆ ê¸°ë¡ ì¶”ê°€ ëª¨ë“œ - ë§ˆì§€ë§‰ ID + 1
            if [ -f record.json ]; then
              RECORD_ID=$(cat record.json | jq '.records | length + 1')
            else
              RECORD_ID=1
            fi
          else
            # ê¸°ì¡´ ê¸°ë¡ ì—…ë°ì´íŠ¸ ëª¨ë“œ - ê¸°ì¡´ ID ìœ ì§€ (ì—†ìœ¼ë©´ 1)
            if [ -f record.json ]; then
              RECORD_ID=$(cat record.json | jq --arg weekStart "$WEEK_START" '.records[] | select(.weekStart == $weekStart) | .id // 1' | head -1)
              if [ -z "$RECORD_ID" ] || [ "$RECORD_ID" = "null" ]; then
                RECORD_ID=1
              fi
            else
              RECORD_ID=1
            fi
          fi
          
          echo "ğŸ†” í• ë‹¹ëœ ID: $RECORD_ID"
          
          # ìƒˆ ê¸°ë¡ ë°ì´í„° (ì™„ì „í•œ êµ¬ì¡°)
          NEW_RECORD=$(jq -n \
            --argjson id "$RECORD_ID" \
            --arg period "$PERIOD" \
            --arg week "${YEAR}ë…„ ${WEEK_NUMBER}ì£¼ì°¨" \
            --argjson commits "$COMMIT_COUNT" \
            --arg status "$STATUS" \
            --argjson success "$SUCCESS" \
            --arg weekStart "$WEEK_START" \
            --arg weekEnd "$WEEK_END" \
            '{
              "id": $id,
              "period": $period,
              "week": $week,
              "commits": $commits,
              "status": $status,
              "success": $success,
              "weekStart": $weekStart,
              "weekEnd": $weekEnd
            }'
          )
          
          if [ "$SHOULD_ADD" = "true" ]; then
            echo "ğŸ†• ìƒˆ ê¸°ë¡ ì¶”ê°€ ëª¨ë“œ"
            
            # ê¸°ì¡´ ê¸°ë¡ì´ ìˆìœ¼ë©´ ê°€ì ¸ì˜¤ê¸°
            if [ -f record.json ]; then
              EXISTING_RECORDS=$(cat record.json | jq '.records')
            else
              EXISTING_RECORDS="[]"
            fi
            
            # ìƒˆ ê¸°ë¡ì„ ê¸°ì¡´ ê¸°ë¡ì— ì¶”ê°€
            UPDATED_RECORDS=$(echo "$EXISTING_RECORDS" | jq ". + [$NEW_RECORD]")
            
          else
            echo "ğŸ”„ ê¸°ì¡´ ê¸°ë¡ ì—…ë°ì´íŠ¸ ëª¨ë“œ"
            
            # ê¸°ì¡´ ê¸°ë¡ì—ì„œ í˜„ì¬ ì£¼ ê¸°ë¡ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
            EXISTING_RECORDS=$(cat record.json | jq '.records')
            UPDATED_RECORDS=$(echo "$EXISTING_RECORDS" | jq --arg weekStart "$WEEK_START" --argjson newRecord "$NEW_RECORD" '
              map(if .weekStart == $weekStart then 
                $newRecord
              else 
                . 
              end)
            ')
          fi
          
          # ìµœì¢… JSON ìƒì„± (ì•ˆì „í•œ ë°©ì‹)
          if ! jq -n \
            --arg username "$USERNAME" \
            --arg avatarUrl "$AVATAR_URL" \
            --arg lastUpdated "$(TZ='Asia/Seoul' date -Iseconds)" \
            --argjson records "$UPDATED_RECORDS" \
            '{
              "username": $username,
              "avatarUrl": $avatarUrl,
              "lastUpdated": $lastUpdated,
              "records": $records
            }' > record.json; then
            echo "âŒ record.json ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi
          
          # JSON ìœ íš¨ì„± ê²€ì‚¬
          if ! jq empty record.json 2>/dev/null; then
            echo "âŒ ìƒì„±ëœ record.jsonì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ"
            exit 1
          fi
          
          echo "âœ… record.json ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      - name: Update record.md
        if: steps.skip_check.outputs.should_skip == 'false' && (steps.should_add_record.outputs.should_add == 'true' || steps.existing_records.outputs.has_records == 'true')
        run: |
          USERNAME="${{ github.repository_owner }}"
          
          echo "ğŸ“ record.md ì—…ë°ì´íŠ¸ ì¤‘..."
          
          # record.md ìƒì„±
          cat > record.md << EOF
          # $USERNAME - Weekly Commit Challenge Record
          
          ## ğŸ“Š ê¸°ë¡ í…Œì´ë¸”
          
          | ID | ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |
          | --- | --- | --- | --- | --- |
          EOF
          
          # record.jsonì—ì„œ ë°ì´í„° ì½ì–´ì„œ í…Œì´ë¸” ìƒì„±
          cat record.json | jq -r '.records[] | "| \(.id) | \(.period) | \(.week) | \(.commits) | \(.status) |"' >> record.md
          
          echo "âœ… record.md ì—…ë°ì´íŠ¸ ì™„ë£Œ"


      - name: Commit and push changes
        if: steps.skip_check.outputs.should_skip == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë³€ê²½ëœ íŒŒì¼ ì¶”ê°€
          git add record.json record.md
          
          # Fork ì‚¬ìš©ìì˜ ê²½ìš° ì‚­ì œëœ ì›Œí¬í”Œë¡œìš°ë„ ì¶”ê°€
          if [ "${{ github.repository_owner }}" != "tlqhrm" ]; then
            git add .github/workflows/ || true
          fi
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if ! git diff --staged --quiet; then
            CURRENT_TIME=$(TZ='Asia/Seoul' date '+%m/%d %H:%M')
            WEEK_NUMBER="${{ steps.week_range.outputs.week_number }}"
            REASON="${{ steps.should_add_record.outputs.reason }}"
            
            git commit -m "ğŸ“Š ${WEEK_NUMBER}ì£¼ì°¨ ìœ„í´ë¦¬ ì»¤ë°‹ ì±Œë¦°ì§€ ê¸°ë¡ ì—…ë°ì´íŠ¸ ($REASON) - $CURRENT_TIME"
            
            echo "ğŸš€ ë³€ê²½ì‚¬í•­ í‘¸ì‹œ ì¤‘..."
            git push
            echo "âœ… ê¸°ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          fi