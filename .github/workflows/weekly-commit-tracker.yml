name: Weekly Commit Tracker

on:
  schedule:
    # ë§¤ì¼ 2ë²ˆ ì‹¤í–‰ (í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 9ì‹œ)
    - cron: '0 0 * * *'   # ë§¤ì¼ UTC 00:00 (í•œêµ­ì‹œê°„ 09:00)
    - cron: '0 12 * * *'  # ë§¤ì¼ UTC 12:00 (í•œêµ­ì‹œê°„ 21:00)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  track-commits:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # OIDC í† í° ìƒì„± ê¶Œí•œ
      contents: read    # ì €ì¥ì†Œ ì½ê¸° ê¶Œí•œ
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check weekly commits across all repositories
        id: check_commits
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ì£¼ì°¨ ê¸°ì¤€ìœ¼ë¡œ ì»¤ë°‹ í™•ì¸ (KST ê¸°ì¤€)
          USERNAME="${{ github.repository_owner }}"
          NOW=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S')
          
          # í˜„ì¬ ìš”ì¼ í™•ì¸ (1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼)
          CURRENT_WEEKDAY=$(TZ='Asia/Seoul' date '+%u')
          
          echo "Current time (KST): $NOW"
          echo "Current weekday: $CURRENT_WEEKDAY (1=Monday, 7=Sunday)"
          echo "Checking commits for user: $USERNAME"
          
          # ì œì™¸í•  ë ˆí¬ì§€í† ë¦¬ ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)
          EXCLUDED_REPOS="weekly-commit-challange"
          
          if [ "$CURRENT_WEEKDAY" -eq 1 ]; then
            # ì›”ìš”ì¼: ì§€ë‚œì£¼ ì›”ìš”ì¼ ~ ì¼ìš”ì¼ (7ì¼ ì „ ~ 1ì¼ ì „)
            WEEK_START=$(TZ='Asia/Seoul' date -d '7 days ago' '+%Y-%m-%d')
            WEEK_END=$(TZ='Asia/Seoul' date -d '1 day ago' '+%Y-%m-%d')
            PERIOD_TYPE="ì§€ë‚œì£¼"
          else
            # í™”~ì¼ìš”ì¼: ì´ë²ˆì£¼ ì›”ìš”ì¼ ~ ì–´ì œê¹Œì§€
            DAYS_SINCE_MONDAY=$((CURRENT_WEEKDAY - 1))
            WEEK_START=$(TZ='Asia/Seoul' date -d "$DAYS_SINCE_MONDAY days ago" '+%Y-%m-%d')
            WEEK_END=$(TZ='Asia/Seoul' date -d '1 day ago' '+%Y-%m-%d')
            PERIOD_TYPE="ì´ë²ˆì£¼"
          fi
          
          echo "Period type: $PERIOD_TYPE"
          echo "Week start: $WEEK_START (Monday)"
          echo "Week end: $WEEK_END"
          
          # ISO 8601 í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          SINCE_DATE=$(TZ='Asia/Seoul' date -d "$WEEK_START 00:00:00" -Iseconds)
          UNTIL_DATE=$(TZ='Asia/Seoul' date -d "$WEEK_END 23:59:59" -Iseconds)
          
          # GitHub GraphQL APIë¡œ ì •í™•í•œ ì»¤ë°‹ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
          echo "ğŸ” GraphQL APIë¡œ ì»¤ë°‹ ìˆ˜ í™•ì¸ ì¤‘..."
          
          GRAPHQL_QUERY=$(cat <<'EOF'
{
  "query": "query($username: String!, $from: DateTime!, $to: DateTime!) {
    user(login: $username) {
      contributionsCollection(from: $from, to: $to) {
        totalCommitContributions
        commitContributionsByRepository {
          repository {
            name
            owner { login }
          }
          contributions {
            totalCount
          }
        }
      }
    }
  }",
  "variables": {
    "username": "'"$USERNAME"'",
    "from": "'"$SINCE_DATE"'",
    "to": "'"$UNTIL_DATE"'"
  }
}
EOF
          )
          
          # GraphQL API í˜¸ì¶œ
          GRAPHQL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$GRAPHQL_QUERY" \
            "https://api.github.com/graphql")
          
          echo "GraphQL Response: $GRAPHQL_RESPONSE"
          
          # GraphQL ì‘ë‹µì—ì„œ ì˜¤ë¥˜ í™•ì¸
          ERROR_CHECK=$(echo "$GRAPHQL_RESPONSE" | jq '.errors // empty')
          if [ -n "$ERROR_CHECK" ]; then
            echo "âŒ GraphQL API ì˜¤ë¥˜ ë°œìƒ:"
            echo "$ERROR_CHECK"
            exit 1
          fi
          
          # ì œì™¸í•  ì €ì¥ì†Œë¥¼ í•„í„°ë§í•˜ì—¬ ì»¤ë°‹ ìˆ˜ ê³„ì‚°
          COMMIT_COUNT=$(echo "$GRAPHQL_RESPONSE" | jq --arg excluded "$EXCLUDED_REPOS" '
            .data.user.contributionsCollection.commitContributionsByRepository
            | map(select(.repository.name as $repo_name | ($excluded | split(",") | index($repo_name) | not)))
            | map(.contributions.totalCount)
            | add // 0
          ')
          
          # ì»¤ë°‹ ìˆ˜ ê²€ì¦
          if [ -z "$COMMIT_COUNT" ] || [ "$COMMIT_COUNT" = "null" ]; then
            echo "âš ï¸ ì»¤ë°‹ ìˆ˜ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 0ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤."
            COMMIT_COUNT=0
          fi
          
          echo "Commit count for $PERIOD_TYPE ($WEEK_START ~ $WEEK_END): $COMMIT_COUNT"
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "period_start=$WEEK_START" >> $GITHUB_OUTPUT
          echo "period_end=$WEEK_END" >> $GITHUB_OUTPUT
          echo "period_type=$PERIOD_TYPE" >> $GITHUB_OUTPUT
          
          if [ $COMMIT_COUNT -gt 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate week number
        id: week_number
        run: |
          # READMEì—ì„œ í˜„ì¬ ì£¼ì°¨ í™•ì¸
          if grep -q "## ğŸ“Š ìœ„í´ë¦¬ ì»¤ë°‹ ì±Œë¦°ì§€ ê¸°ë¡" README.md; then
            CURRENT_WEEK=$(grep -o "[0-9]*ì£¼ì°¨" README.md | tail -1 | grep -o "[0-9]*" || echo "0")
          else
            CURRENT_WEEK=0
          fi
          
          NEW_WEEK=$((CURRENT_WEEK + 1))
          echo "week_number=$NEW_WEEK" >> $GITHUB_OUTPUT
          echo "Current week: $CURRENT_WEEK, New week: $NEW_WEEK"

      - name: Get GitHub OIDC Token
        id: get_token
        run: |
          # GitHub Actions OIDC í† í° ê°€ì ¸ì˜¤ê¸°
          OIDC_TOKEN=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=weekly-commit-challenge" \
            -H "User-Agent: actions/oidc-client" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
            | jq -r '.value')
          
          echo "oidc_token=$OIDC_TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… OIDC Token obtained successfully"

      - name: Send weekly data to Lambda via API Gateway (OIDC)
        env:
          API_ENDPOINT: ${{ secrets.API_ENDPOINT }}
        run: |
          # API ì„¤ì •ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì „ì†¡
          if [ -n "$API_ENDPOINT" ]; then
            COMMIT_COUNT="${{ steps.check_commits.outputs.commit_count }}"
            SUCCESS="${{ steps.check_commits.outputs.success }}"
            WEEK_NUM="${{ steps.week_number.outputs.week_number }}"
            USERNAME="${{ github.repository_owner }}"
            PERIOD_START="${{ steps.check_commits.outputs.period_start }}"
            PERIOD_END="${{ steps.check_commits.outputs.period_end }}"
            CURRENT_TIME=$(TZ='Asia/Seoul' date -Iseconds)
            YEAR=$(TZ='Asia/Seoul' date '+%Y')
            OIDC_TOKEN="${{ steps.get_token.outputs.oidc_token }}"
            
            # OIDC í† í°ê³¼ í•¨ê»˜ ë°ì´í„° ìƒì„±
            PAYLOAD="{\"username\":\"$USERNAME\",\"year\":$YEAR,\"weekNumber\":$WEEK_NUM,\"commitCount\":$COMMIT_COUNT,\"success\":$SUCCESS,\"periodStart\":\"$PERIOD_START\",\"periodEnd\":\"$PERIOD_END\",\"lastUpdated\":\"$CURRENT_TIME\",\"repository\":\"${{ github.repository }}\",\"runId\":\"${{ github.run_id }}\",\"sha\":\"${{ github.sha }}\",\"actor\":\"${{ github.actor }}\"}"
            
            echo "Lambdaë¡œ ì£¼ê°„ ë°ì´í„° ì „ì†¡ ì¤‘ (OIDC ì¸ì¦)..."
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "$API_ENDPOINT/weekly-commit-record" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OIDC_TOKEN" \
              -d "$PAYLOAD")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
              echo "âœ… Lambda ì‘ë‹µ ì„±ê³µ (HTTP $HTTP_CODE): $RESPONSE_BODY"
              echo "âœ… DynamoDBì— ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "âš ï¸ Lambda ì‘ë‹µ ì‹¤íŒ¨ (HTTP $HTTP_CODE): $RESPONSE_BODY"
              echo "âš ï¸ API ì „ì†¡ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì†)"
            fi
          else
            echo "â„¹ï¸ API_ENDPOINTê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. READMEë§Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
          fi

      - name: Update record.md with tracking record (Daily sync)
        run: |
          COMMIT_COUNT="${{ steps.check_commits.outputs.commit_count }}"
          SUCCESS="${{ steps.check_commits.outputs.success }}"
          WEEK_NUM="${{ steps.week_number.outputs.week_number }}"
          PERIOD_START="${{ steps.check_commits.outputs.period_start }}"
          PERIOD_END="${{ steps.check_commits.outputs.period_end }}"
          
          # í˜„ì¬ ì—°ë„ ê°€ì ¸ì˜¤ê¸°
          YEAR=$(TZ='Asia/Seoul' date '+%Y')
          
          # ì£¼ì°¨ì˜ ì‹¤ì œ ì‹œì‘ì¼(ì›”ìš”ì¼)ê³¼ ì¢…ë£Œì¼(ì¼ìš”ì¼) ê³„ì‚°
          # PERIOD_STARTë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê·¸ ì£¼ì˜ ì›”ìš”ì¼ ì°¾ê¸°
          START_DATE=$(TZ='Asia/Seoul' date -d "$PERIOD_START" '+%Y-%m-%d')
          START_WEEKDAY=$(TZ='Asia/Seoul' date -d "$START_DATE" '+%u') # 1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼
          
          # ì›”ìš”ì¼ê¹Œì§€ ë‚ ì§œë¥¼ ë’¤ë¡œ ì´ë™
          DAYS_TO_SUBTRACT=$((START_WEEKDAY - 1))
          MONDAY=$(TZ='Asia/Seoul' date -d "$START_DATE - $DAYS_TO_SUBTRACT days" '+%m/%d')
          
          # ì¼ìš”ì¼ ê³„ì‚° (ì›”ìš”ì¼ + 6ì¼)
          SUNDAY=$(TZ='Asia/Seoul' date -d "$START_DATE - $DAYS_TO_SUBTRACT days + 6 days" '+%m/%d')
          
          # ê¸°ê°„ í¬ë§·: M/D ~ M/D í˜•íƒœ
          WEEK_PERIOD="$MONDAY ~ $SUNDAY"
          
          # ì§„í–‰ì¤‘/ì™„ë£Œ ìƒíƒœ ì„¤ì •
          CURRENT_TIME=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          if [ "$SUCCESS" = "true" ]; then
            STATUS_EMOJI="âœ… ì„±ê³µ"
            BADGE="![Weekly Commit Challenge](https://img.shields.io/badge/Weekly%20Commit%20Challenge-${WEEK_NUM}ì£¼ì°¨%20ì„±ê³µ-brightgreen)"
          else
            STATUS_EMOJI="ğŸ”„ ì§„í–‰ì¤‘ ($COMMIT_COUNTê°œ)"
            BADGE="![Weekly Commit Challenge](https://img.shields.io/badge/Weekly%20Commit%20Challenge-${WEEK_NUM}ì£¼ì°¨%20ì§„í–‰ì¤‘-blue)"
          fi
          
          # JSON í˜•íƒœë¡œ ê¸°ë¡ ìƒì„± (APIìš©)
          RECORD_JSON="{\"period\":\"$WEEK_PERIOD\",\"year\":$YEAR,\"weekNumber\":$WEEK_NUM,\"commitCount\":$COMMIT_COUNT,\"success\":$SUCCESS,\"status\":\"$STATUS_EMOJI\",\"lastUpdated\":\"$(TZ='Asia/Seoul' date -Iseconds)\"}"
          
          # record.md ì—…ë°ì´íŠ¸ (JSONê³¼ ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ë³‘í–‰)
          cat > record.md << EOL
# ${{ github.repository_owner }} - Weekly Commit Challenge Record

## ğŸ“Š JSON Data

\`\`\`json
$RECORD_JSON
\`\`\`

EOL
          
          # í…Œì´ë¸” í˜•íƒœ ê¸°ë¡ë„ record.mdì— ì¶”ê°€
          NEW_RECORD="| $WEEK_PERIOD | ${YEAR}ë…„ ${WEEK_NUM}ì£¼ì°¨ | $COMMIT_COUNT | $STATUS_EMOJI |"
          CURRENT_WEEK_PATTERN="${YEAR}ë…„ ${WEEK_NUM}ì£¼ì°¨"
          
          # record.mdì— í…Œì´ë¸” ì„¹ì…˜ë„ ì¶”ê°€
          if grep -q "## ğŸ“Š ê¸°ë¡ í…Œì´ë¸”" record.md; then
            # í˜„ì¬ ì£¼ì°¨ ê¸°ë¡ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
            if grep -q "$CURRENT_WEEK_PATTERN" record.md; then
              # í˜„ì¬ ì£¼ì°¨ ê¸°ë¡ì„ ì—…ë°ì´íŠ¸ (REPLACE)
              sed -i "/$CURRENT_WEEK_PATTERN/c\\$NEW_RECORD" record.md
              echo "ğŸ“ í˜„ì¬ ì£¼ì°¨ ê¸°ë¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤: $CURRENT_WEEK_PATTERN"
            else
              # ìƒˆë¡œìš´ ì£¼ì°¨ ê¸°ë¡ ì¶”ê°€
              sed -i "/| --- | --- | --- | --- |/a $NEW_RECORD" record.md
              echo "ğŸ“ ìƒˆë¡œìš´ ì£¼ì°¨ ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: $CURRENT_WEEK_PATTERN"
            fi
          else
            # í…Œì´ë¸” ì„¹ì…˜ ì¶”ê°€
            {
              echo ""
              echo "## ğŸ“Š ê¸°ë¡ í…Œì´ë¸”"
              echo ""
              echo "| ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |"
              echo "| --- | --- | --- | --- |"
              echo "$NEW_RECORD"
            } >> record.md
            echo "ğŸ“ ê¸°ë¡ í…Œì´ë¸” ì„¹ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add record.md
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
          if ! git diff --staged --quiet; then
            CURRENT_TIME=$(TZ='Asia/Seoul' date '+%m/%d %H:%M')
            git commit -m "ğŸ“Š ${{ steps.week_number.outputs.week_number }}ì£¼ì°¨ ìœ„í´ë¦¬ ì»¤ë°‹ ì±Œë¦°ì§€ ê¸°ë¡ ì—…ë°ì´íŠ¸ ($CURRENT_TIME)"
            git push
            echo "âœ… record.md ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi