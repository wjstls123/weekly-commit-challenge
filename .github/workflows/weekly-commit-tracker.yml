name: Weekly Commit Tracker

on:
  schedule:
    - cron: '0 0 * * *'   # ë§¤ì¼ UTC 00:00 (í•œêµ­ì‹œê°„ 09:00)
    - cron: '0 12 * * *'  # ë§¤ì¼ UTC 12:00 (í•œêµ­ì‹œê°„ 21:00)
  workflow_dispatch:

jobs:
  track-commits:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check weekly commits
        id: check_commits
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USERNAME="${{ github.repository_owner }}"
          NOW=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S')
          CURRENT_WEEKDAY=$(TZ='Asia/Seoul' date '+%u')
          
          echo "Current time (KST): $NOW"
          echo "Checking commits for user: $USERNAME"
          
          EXCLUDED_REPOS="weekly-commit-challenge"
          
          if [ "$CURRENT_WEEKDAY" -eq 1 ]; then
            WEEK_START=$(TZ='Asia/Seoul' date -d '7 days ago' '+%Y-%m-%d')
            WEEK_END=$(TZ='Asia/Seoul' date -d '1 day ago' '+%Y-%m-%d')
            PERIOD_TYPE="ì§€ë‚œì£¼"
          else
            DAYS_SINCE_MONDAY=$((CURRENT_WEEKDAY - 1))
            WEEK_START=$(TZ='Asia/Seoul' date -d "$DAYS_SINCE_MONDAY days ago" '+%Y-%m-%d')
            WEEK_END=$(TZ='Asia/Seoul' date -d '1 day ago' '+%Y-%m-%d')
            PERIOD_TYPE="ì´ë²ˆì£¼"
          fi
          
          echo "Week start: $WEEK_START, Week end: $WEEK_END"
          
          # í•œêµ­ ì‹œê°„ì„ UTCë¡œ ë³€í™˜ (KST - 9ì‹œê°„)
          SINCE_DATE_UTC=$(TZ='UTC' date -d "$WEEK_START 00:00:00 KST" -Iseconds)
          UNTIL_DATE_UTC=$(TZ='UTC' date -d "$WEEK_END 23:59:59 KST" -Iseconds)
          
          echo "KST Week start: $WEEK_START 00:00:00"
          echo "KST Week end: $WEEK_END 23:59:59"
          echo "UTC Since date: $SINCE_DATE_UTC"
          echo "UTC Until date: $UNTIL_DATE_UTC"
          
          # GraphQL ì¿¼ë¦¬ ìƒì„± (ìœ ì € ì •ë³´ì™€ ì»¤ë°‹ ì •ë³´ í•¨ê»˜ ì¡°íšŒ)
          echo '{"query":"query($username: String!, $from: DateTime!, $to: DateTime!) { user(login: $username) { avatarUrl contributionsCollection(from: $from, to: $to) { totalCommitContributions commitContributionsByRepository { repository { name owner { login } } contributions { totalCount } } } } }","variables":{"username":"'$USERNAME'","from":"'$SINCE_DATE_UTC'","to":"'$UNTIL_DATE_UTC'"}}' > /tmp/query.json
          
          # GraphQL API í˜¸ì¶œ
          GRAPHQL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d @/tmp/query.json \
            "https://api.github.com/graphql")
          
          echo "GraphQL Response: $GRAPHQL_RESPONSE"
          
          # ìœ ì € ì•„ë°”íƒ€ URL ì¶”ì¶œ
          AVATAR_URL=$(echo "$GRAPHQL_RESPONSE" | jq -r '.data.user.avatarUrl // ""')
          
          # ì»¤ë°‹ ìˆ˜ ê³„ì‚°
          COMMIT_COUNT=$(echo "$GRAPHQL_RESPONSE" | jq --arg excluded "$EXCLUDED_REPOS" '
            .data.user.contributionsCollection.commitContributionsByRepository
            | map(select(.repository.name as $repo_name | ($excluded | split(",") | index($repo_name) | not)))
            | map(.contributions.totalCount)
            | add // 0
          ')
          
          if [ -z "$COMMIT_COUNT" ] || [ "$COMMIT_COUNT" = "null" ]; then
            COMMIT_COUNT=0
          fi
          
          echo "Commit count: $COMMIT_COUNT"
          echo "Avatar URL: $AVATAR_URL"
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "period_start=$WEEK_START" >> $GITHUB_OUTPUT
          echo "period_end=$WEEK_END" >> $GITHUB_OUTPUT
          echo "period_type=$PERIOD_TYPE" >> $GITHUB_OUTPUT
          echo "avatar_url=$AVATAR_URL" >> $GITHUB_OUTPUT
          
          if [ $COMMIT_COUNT -gt 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate week number
        id: week_number
        run: |
          YEAR=$(TZ='Asia/Seoul' date '+%Y')
          WEEK_NUMBER=$(node -e "
            // í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì£¼ì°¨ ê³„ì‚°
            const now = new Date();
            const kstOffset = 9 * 60 * 60 * 1000; // 9ì‹œê°„ì„ ë°€ë¦¬ì´ˆë¡œ
            const kstNow = new Date(now.getTime() + kstOffset);
            
            const target = new Date(kstNow.valueOf());
            const dayNr = (target.getDay() + 6) % 7; // ì›”ìš”ì¼ì„ 0ìœ¼ë¡œ
            target.setDate(target.getDate() - dayNr + 3); // ëª©ìš”ì¼ë¡œ ì´ë™
            const jan4 = new Date(target.getFullYear(), 0, 4); // 1ì›” 4ì¼
            const dayDiff = (target - jan4) / 86400000;
            console.log(Math.ceil(dayDiff / 7));
          ")
          
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "Year: $YEAR, Week: $WEEK_NUMBER (KST ê¸°ì¤€)"

      - name: Update record.md
        run: |
          COMMIT_COUNT="${{ steps.check_commits.outputs.commit_count }}"
          SUCCESS="${{ steps.check_commits.outputs.success }}"
          WEEK_NUM="${{ steps.week_number.outputs.week_number }}"
          PERIOD_START="${{ steps.check_commits.outputs.period_start }}"
          PERIOD_END="${{ steps.check_commits.outputs.period_end }}"
          YEAR=$(TZ='Asia/Seoul' date '+%Y')
          
          # ì£¼ì°¨ ê¸°ê°„ ê³„ì‚°
          START_DATE=$(TZ='Asia/Seoul' date -d "$PERIOD_START" '+%Y-%m-%d')
          START_WEEKDAY=$(TZ='Asia/Seoul' date -d "$START_DATE" '+%u')
          DAYS_TO_SUBTRACT=$((START_WEEKDAY - 1))
          MONDAY=$(TZ='Asia/Seoul' date -d "$START_DATE - $DAYS_TO_SUBTRACT days" '+%m/%d')
          SUNDAY=$(TZ='Asia/Seoul' date -d "$START_DATE - $DAYS_TO_SUBTRACT days + 6 days" '+%m/%d')
          WEEK_PERIOD="$MONDAY ~ $SUNDAY"
          
          if [ "$SUCCESS" = "true" ]; then
            STATUS_EMOJI="âœ… ì„±ê³µ"
          else
            STATUS_EMOJI="ğŸ”„ ì§„í–‰ì¤‘ ($COMMIT_COUNTê°œ)"
          fi
          
          # ì•„ë°”íƒ€ URL ê°€ì ¸ì˜¤ê¸°
          AVATAR_URL="${{ steps.check_commits.outputs.avatar_url }}"
          
          # JSON ë°ì´í„° ìƒì„±
          echo '{"period":"'$WEEK_PERIOD'","year":'$YEAR',"weekNumber":'$WEEK_NUM',"commitCount":'$COMMIT_COUNT',"success":'$SUCCESS',"status":"'$STATUS_EMOJI'","lastUpdated":"'$(TZ='Asia/Seoul' date -Iseconds)'","username":"${{ github.repository_owner }}","avatarUrl":"'$AVATAR_URL'"}' > /tmp/record.json
          RECORD_JSON=$(cat /tmp/record.json)
          
          # record.md ìƒì„±
          {
            echo "# ${{ github.repository_owner }} - Weekly Commit Challenge Record"
            echo ""
            echo "## ğŸ“Š JSON Data"
            echo ""
            echo '```json'
            echo "$RECORD_JSON"
            echo '```'
            echo ""
            echo "## ğŸ“Š ê¸°ë¡ í…Œì´ë¸”"
            echo ""
            echo "| ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€ |"
            echo "| --- | --- | --- | --- |"
            echo "| $WEEK_PERIOD | ${YEAR}ë…„ ${WEEK_NUM}ì£¼ì°¨ | $COMMIT_COUNT | $STATUS_EMOJI |"
          } > record.md

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add record.md
          
          if ! git diff --staged --quiet; then
            CURRENT_TIME=$(TZ='Asia/Seoul' date '+%m/%d %H:%M')
            git commit -m "ğŸ“Š ${{ steps.week_number.outputs.week_number }}ì£¼ì°¨ ìœ„í´ë¦¬ ì»¤ë°‹ ì±Œë¦°ì§€ ê¸°ë¡ ì—…ë°ì´íŠ¸ ($CURRENT_TIME)"
            git push
            echo "âœ… record.md ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi
