name: Collect Fork Statistics

on:
  schedule:
    - cron: '0 * * * *'  # ë§¤ì‹œê°„ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect-statistics:
    runs-on: ubuntu-latest
    # forkì—ì„œëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    if: github.repository == 'tlqhrm/weekly-commit-challenge'
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Collect fork statistics and save to issue
        id: collect_stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');
          
          // GitHub API í˜¸ì¶œ í•¨ìˆ˜ (GET/POST/PATCH ì§€ì›)
          function githubAPI(path, method = 'GET', body = null) {
              return new Promise((resolve, reject) => {
                  const options = {
                      hostname: 'api.github.com',
                      path: path,
                      method: method,
                      headers: {
                          'User-Agent': 'weekly-commit-challenge',
                          'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                          'Accept': 'application/vnd.github.v3+json'
                      }
                  };
                  
                  if (body) {
                      options.headers['Content-Type'] = 'application/json';
                  }
                  
                  const req = https.request(options, (res) => {
                      let data = '';
                      res.on('data', chunk => data += chunk);
                      res.on('end', () => {
                          if (res.statusCode >= 200 && res.statusCode < 300) {
                              resolve(data ? JSON.parse(data) : {});
                          } else {
                              reject(new Error(`API Error: ${res.statusCode} - ${data}`));
                          }
                      });
                  });
                  
                  req.on('error', reject);
                  
                  if (body) {
                      req.write(JSON.stringify(body));
                  }
                  
                  req.end();
              });
          }
          
          async function collectStatistics() {
              console.log('í†µê³„ ìˆ˜ì§‘ ì‹œì‘...');
              
              const stats = {
                  lastUpdated: new Date().toISOString(),
                  totalParticipants: 0,
                  activeParticipants: 0,
                  recordHolders: 0,
                  weeklySuccessful: 0,
                  participants: []
              };
              
              try {
                  // Fork ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                  let page = 1;
                  let allForks = [];
                  
                  while (true) {
                      const forks = await githubAPI(`/repos/tlqhrm/weekly-commit-challenge/forks?page=${page}&per_page=100`);
                      if (forks.length === 0) break;
                      allForks.push(...forks);
                      if (forks.length < 100) break;
                      page++;
                  }
                  
                  stats.totalParticipants = allForks.length;
                  console.log(`ì´ ${allForks.length}ê°œì˜ fork ë°œê²¬`);
                  
                  // í™œì„± ì°¸ì—¬ì ê³„ì‚°
                  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                  stats.activeParticipants = allForks.filter(fork => 
                      new Date(fork.pushed_at) > thirtyDaysAgo
                  ).length;
                  
                  // ê° forkì˜ record.md í™•ì¸ (ë°°ì¹˜ ì²˜ë¦¬)
                  for (let i = 0; i < allForks.length; i += 5) {
                      const batch = allForks.slice(i, i + 5);
                      
                      await Promise.all(batch.map(async (fork) => {
                          try {
                              // record.md ì¡´ì¬ í™•ì¸
                              const recordResponse = await githubAPI(
                                  `/repos/${fork.owner.login}/${fork.name}/contents/record.md`
                              );
                              
                              if (recordResponse) {
                                  stats.recordHolders++;
                                  
                                  // record.md ë‚´ìš© ë¶„ì„
                                  const content = Buffer.from(recordResponse.content, 'base64').toString();
                                  const lines = content.split('\\n');
                                  let currentStreak = 0;
                                  let totalWeeks = 0;
                                  let currentWeekSuccess = false;
                                  
                                  // ê°„ë‹¨í•œ íŒŒì‹±
                                  for (const line of lines) {
                                      if (line.includes('|') && !line.includes('---') && !line.includes('ê¸°ê°„')) {
                                          totalWeeks++;
                                          if (line.includes('âœ…')) {
                                              if (totalWeeks === 1) currentWeekSuccess = true;
                                              if (currentStreak === totalWeeks - 1) currentStreak++;
                                          }
                                      }
                                  }
                                  
                                  if (currentWeekSuccess) stats.weeklySuccessful++;
                                  
                                  stats.participants.push({
                                      username: fork.owner.login,
                                      avatarUrl: fork.owner.avatar_url,
                                      lastPushed: fork.pushed_at,
                                      currentStreak,
                                      totalWeeks,
                                      currentWeekSuccess
                                  });
                              }
                          } catch (err) {
                              console.error(`${fork.owner.login} ì²˜ë¦¬ ì‹¤íŒ¨:`, err.message);
                          }
                      }));
                      
                      // API ì œí•œ ëŒ€ë¹„ ì§€ì—°
                      await new Promise(resolve => setTimeout(resolve, 500));
                  }
                  
                  // í‰ê·  ì—°ì† ì£¼ì°¨ ê³„ì‚°
                  if (stats.participants.length > 0) {
                      const totalStreak = stats.participants.reduce((sum, p) => sum + p.currentStreak, 0);
                      stats.averageStreak = Math.round(totalStreak / stats.participants.length * 10) / 10;
                  }
                  
                  // Issueì— ì €ì¥í•˜ê¸° ìœ„í•´ GitHub API í˜¸ì¶œ
                  console.log('Issueì— í†µê³„ ì €ì¥ ì¤‘...');
                  
                  // ê¸°ì¡´ í†µê³„ Issue ì°¾ê¸°
                  const issues = await githubAPI('/repos/tlqhrm/weekly-commit-challenge/issues?labels=statistics&state=open');
                  
                  // Issue ë³¸ë¬¸ ìƒì„±
                  const updateTime = new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'});
                  const jsonData = JSON.stringify(stats, null, 2);
                  
                  const issueBody = '# ğŸ“Š Fork í†µê³„ (ìë™ ì—…ë°ì´íŠ¸)\\n\\n' +
                    '**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:** ' + updateTime + '\\n\\n' +
                    '## JSON ë°ì´í„°\\n\\n' +
                    '```json\\n' + jsonData + '\\n```\\n\\n' +
                    '## ìš”ì•½\\n' +
                    '- ì´ ì°¸ì—¬ì: ' + stats.totalParticipants + 'ëª…\\n' +
                    '- í™œì„± ì°¸ì—¬ì: ' + stats.activeParticipants + 'ëª…\\n' +
                    '- record.md ë³´ìœ ì: ' + stats.recordHolders + 'ëª…\\n' +
                    '- ì£¼ê°„ ì„±ê³µì: ' + stats.weeklySuccessful + 'ëª…\\n' +
                    '- í‰ê·  ì—°ì† ì£¼ì°¨: ' + stats.averageStreak + 'ì£¼';
                  
                  if (issues.length > 0) {
                      // ê¸°ì¡´ Issue ì—…ë°ì´íŠ¸
                      const issueNumber = issues[0].number;
                      await githubAPI(`/repos/tlqhrm/weekly-commit-challenge/issues/${issueNumber}`, 'PATCH', {
                          title: 'ğŸ“Š Fork í†µê³„ ë°ì´í„°',
                          body: issueBody
                      });
                      console.log(`Issue #${issueNumber} ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
                  } else {
                      // ìƒˆ Issue ìƒì„±
                      const newIssue = await githubAPI('/repos/tlqhrm/weekly-commit-challenge/issues', 'POST', {
                          title: 'ğŸ“Š Fork í†µê³„ ë°ì´í„°',
                          body: issueBody,
                          labels: ['statistics', 'automation']
                      });
                      console.log(`ìƒˆ Issue #${newIssue.number} ìƒì„± ì™„ë£Œ`);
                  }
                  
                  console.log('í†µê³„ ìˆ˜ì§‘ ë° ì €ì¥ ì™„ë£Œ!');
                  
              } catch (error) {
                  console.error('í†µê³„ ìˆ˜ì§‘ ì‹¤íŒ¨:', error);
                  process.exit(1);
              }
          }
          
          collectStatistics();
          EOF