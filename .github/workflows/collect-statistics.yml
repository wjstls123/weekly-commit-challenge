name: Collect Fork Statistics

on:
  schedule:
    - cron: '*/10 * * * *'  # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect-statistics:
    runs-on: ubuntu-latest
    # forkì—ì„œëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    if: github.repository == 'tlqhrm/weekly-commit-challenge'
    permissions:
      contents: write
      issues: write
      pull-requests: read
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Collect fork statistics and save to issue
        id: collect_stats
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');
          
          // GitHub API í˜¸ì¶œ í•¨ìˆ˜ (GET/POST/PATCH ì§€ì›)
          function githubAPI(path, method = 'GET', body = null) {
              return new Promise((resolve, reject) => {
                  const options = {
                      hostname: 'api.github.com',
                      path: path,
                      method: method,
                      headers: {
                          'User-Agent': 'weekly-commit-challenge',
                          'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                          'Accept': 'application/vnd.github.v3+json'
                      }
                  };
                  
                  if (body) {
                      options.headers['Content-Type'] = 'application/json';
                  }
                  
                  const req = https.request(options, (res) => {
                      let data = '';
                      res.on('data', chunk => data += chunk);
                      res.on('end', () => {
                          if (res.statusCode >= 200 && res.statusCode < 300) {
                              resolve(data ? JSON.parse(data) : {});
                          } else {
                              reject(new Error(`API Error: ${res.statusCode} - ${data}`));
                          }
                      });
                  });
                  
                  req.on('error', reject);
                  
                  if (body) {
                      req.write(JSON.stringify(body));
                  }
                  
                  req.end();
              });
          }
          
          async function collectStatistics() {
              console.log('í†µê³„ ìˆ˜ì§‘ ì‹œì‘...');
              
              const stats = {
                  lastUpdated: new Date().toISOString(),
                  totalParticipants: 0,
                  activeParticipants: 0,
                  recordHolders: 0,
                  weeklySuccessful: 0,
                  participants: []
              };
              
              try {
                  // Fork ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                  let page = 1;
                  let allForks = [];
                  
                  while (true) {
                      const forks = await githubAPI(`/repos/tlqhrm/weekly-commit-challenge/forks?page=${page}&per_page=100`);
                      if (forks.length === 0) break;
                      allForks.push(...forks);
                      if (forks.length < 100) break;
                      page++;
                  }
                  
                  // ì›ë³¸ ë ˆí¬ì§€í† ë¦¬ë„ í¬í•¨
                  const originalRepo = await githubAPI('/repos/tlqhrm/weekly-commit-challenge');
                  allForks.unshift({
                      owner: { login: 'tlqhrm', avatar_url: originalRepo.owner.avatar_url },
                      name: 'weekly-commit-challenge',
                      pushed_at: originalRepo.pushed_at
                  });
                  
                  stats.totalParticipants = allForks.length;
                  console.log(`ì´ ${allForks.length}ê°œì˜ ë ˆí¬ì§€í† ë¦¬ ë°œê²¬ (ì›ë³¸ í¬í•¨)`);
                  
                  // ê° forkì˜ record.md í™•ì¸ (ë°°ì¹˜ ì²˜ë¦¬)
                  for (let i = 0; i < allForks.length; i += 5) {
                      const batch = allForks.slice(i, i + 5);
                      
                      await Promise.all(batch.map(async (fork) => {
                          try {
                              let participantData = null;
                              
                              // ë¨¼ì € record.json ì‹œë„
                              try {
                                  const jsonResponse = await githubAPI(
                                      `/repos/${fork.owner.login}/${fork.name}/contents/record.json`
                                  );
                                  
                                  if (jsonResponse) {
                                      const jsonContent = Buffer.from(jsonResponse.content, 'base64').toString();
                                      const recordData = JSON.parse(jsonContent);
                                      
                                      // ë°ì´í„° ì†Œìœ ì ê²€ì¦: record.jsonì˜ usernameì´ fork ì†Œìœ ìì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                                      const dataOwner = recordData.username;
                                      if (dataOwner && dataOwner !== fork.owner.login) {
                                          console.log(`${fork.owner.login}: ë‹¤ë¥¸ ì‚¬ìš©ì(${dataOwner})ì˜ ë°ì´í„°ë¥¼ í¬í•¨í•˜ê³  ìˆì–´ ì œì™¸ë¨`);
                                          return; // ì´ forkëŠ” í†µê³„ì—ì„œ ì œì™¸
                                      }
                                      
                                      if (recordData.records && recordData.records.length > 0) {
                                          const records = recordData.records;
                                          let currentStreak = 0;
                                          let maxStreak = 0;
                                          let tempStreak = 0;
                                          let successWeeks = 0;
                                          
                                          // ìµœì‹ ë¶€í„° ì—­ìˆœìœ¼ë¡œ í˜„ì¬ ì—°ì† ê³„ì‚°
                                          for (let i = records.length - 1; i >= 0; i--) {
                                              if (records[i].success) {
                                                  currentStreak++;
                                              } else {
                                                  break;
                                              }
                                          }
                                          
                                          // ìµœì¥ ì—°ì† ê³„ì‚°
                                          for (const record of records) {
                                              if (record.success) {
                                                  tempStreak++;
                                                  maxStreak = Math.max(maxStreak, tempStreak);
                                                  successWeeks++;
                                              } else {
                                                  tempStreak = 0;
                                              }
                                          }
                                          
                                          const lastRecord = records[records.length - 1];
                                          const currentWeekSuccess = lastRecord ? lastRecord.success : false;
                                          const successRate = records.length > 0 ? Math.round((successWeeks / records.length) * 100 * 10) / 10 : 0;
                                          
                                          participantData = {
                                              username: fork.owner.login,
                                              avatarUrl: recordData.avatarUrl || fork.owner.avatar_url,
                                              lastPushed: fork.pushed_at,
                                              currentStreak: currentStreak,
                                              maxStreak: maxStreak,
                                              totalWeeks: records.length,
                                              successRate: successRate,
                                              currentWeekSuccess: currentWeekSuccess,
                                              currentWeekCommits: lastRecord ? lastRecord.commits : 0
                                          };
                                          
                                          if (currentWeekSuccess) stats.weeklySuccessful++;
                                          console.log(`${fork.owner.login}: record.json ì‚¬ìš© - ${records.length}ì£¼ ê¸°ë¡`);
                                      }
                                  }
                              } catch (jsonError) {
                                  console.log(`${fork.owner.login}: record.json ì—†ìŒ, record.md ì‹œë„`);
                              }
                              
                              // record.jsonì´ ì—†ìœ¼ë©´ record.md ì‚¬ìš©
                              if (!participantData) {
                                  const recordResponse = await githubAPI(
                                      `/repos/${fork.owner.login}/${fork.name}/contents/record.md`
                                  );
                                  
                                  if (recordResponse) {
                                      // record.md ë‚´ìš© ë¶„ì„
                                      const content = Buffer.from(recordResponse.content, 'base64').toString();
                                      const lines = content.split('\\n');
                                      
                                      // ë°ì´í„° ì†Œìœ ì ê²€ì¦: record.md í—¤ë”ì—ì„œ username í™•ì¸
                                      const headerLine = lines.find(line => line.includes('# ') && line.includes(' - Weekly Commit Challenge Record'));
                                      if (headerLine) {
                                          const dataOwner = headerLine.split(' - Weekly Commit Challenge Record')[0].replace('# ', '').trim();
                                          if (dataOwner && dataOwner !== fork.owner.login) {
                                              console.log(`${fork.owner.login}: ë‹¤ë¥¸ ì‚¬ìš©ì(${dataOwner})ì˜ ë°ì´í„°ë¥¼ í¬í•¨í•˜ê³  ìˆì–´ ì œì™¸ë¨`);
                                              return; // ì´ forkëŠ” í†µê³„ì—ì„œ ì œì™¸
                                          }
                                      }
                                      let currentStreak = 0;
                                      let totalWeeks = 0;
                                      let successWeeks = 0;
                                      let currentWeekSuccess = false;
                                      
                                      // ìƒì„¸í•œ íŒŒì‹±ìœ¼ë¡œ ìµœì¥ ì—°ì† ì£¼ì°¨ ê³„ì‚°
                                      const records = [];
                                      let latestCommitCount = 0;
                                      for (const line of lines) {
                                          if (line.includes('|') && !line.includes('---') && !line.includes('ê¸°ê°„')) {
                                              totalWeeks++;
                                              const isSuccess = line.includes('âœ…');
                                              
                                              // ì»¤ë°‹ ìˆ˜ ì¶”ì¶œ (í…Œì´ë¸” êµ¬ì¡°ì— ë”°ë¼)
                                              const parts = line.split('|').map(p => p.trim());
                                              let commits = 0;
                                              if (parts.length >= 6) {
                                                  // ID | ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€
                                                  commits = parseInt(parts[4]) || 0;
                                              } else if (parts.length >= 5) {
                                                  // ê¸°ê°„ | ì£¼ì°¨ | ì»¤ë°‹ ìˆ˜ | ì„±ê³µ ì—¬ë¶€
                                                  commits = parseInt(parts[3]) || 0;
                                              }
                                              
                                              // ìµœì‹  ê¸°ë¡ì„ ê³„ì† ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ì— íŒŒì‹±ëœ ê²ƒì´ ìµœì‹ )
                                              latestCommitCount = commits;
                                              
                                              records.push({ success: isSuccess, commits: commits });
                                              
                                              if (isSuccess) {
                                                  successWeeks++;
                                              }
                                          }
                                      }
                                      
                                      // ìµœì‹  ê¸°ë¡ì˜ ì„±ê³µ ì—¬ë¶€ í™•ì¸ (ë§ˆì§€ë§‰ ê¸°ë¡)
                                      if (records.length > 0) {
                                          currentWeekSuccess = records[records.length - 1].success;
                                      }
                                      
                                      // í˜„ì¬ ì—°ì† ì£¼ì°¨ ë° ìµœì¥ ì—°ì† ì£¼ì°¨ ê³„ì‚°
                                      let maxStreak = 0;
                                      currentStreak = 0;
                                      let tempStreak = 0;
                                      
                                      // ìµœì‹ ë¶€í„° ì—­ìˆœìœ¼ë¡œ í˜„ì¬ ì—°ì† ê³„ì‚°
                                      for (let i = 0; i < records.length; i++) {
                                          if (records[i].success) {
                                              if (i === 0) currentStreak++;
                                              else if (currentStreak === i) currentStreak++;
                                              else break;
                                          } else {
                                              break;
                                          }
                                      }
                                      
                                      // ì „ì²´ì—ì„œ ìµœì¥ ì—°ì† ê³„ì‚°
                                      for (const record of records) {
                                          if (record.success) {
                                              tempStreak++;
                                              maxStreak = Math.max(maxStreak, tempStreak);
                                          } else {
                                              tempStreak = 0;
                                          }
                                      }
                                      
                                      if (currentWeekSuccess) stats.weeklySuccessful++;
                                      
                                      // ì„±ê³µë¥  ê³„ì‚°
                                      const successRate = totalWeeks > 0 ? Math.round((successWeeks / totalWeeks) * 100 * 10) / 10 : 0;
                                      
                                      participantData = {
                                          username: fork.owner.login,
                                          avatarUrl: fork.owner.avatar_url,
                                          lastPushed: fork.pushed_at,
                                          currentStreak,
                                          maxStreak,
                                          totalWeeks,
                                          successRate,
                                          currentWeekSuccess,
                                          currentWeekCommits: latestCommitCount
                                      };
                                      console.log(`${fork.owner.login}: record.md ì‚¬ìš©`);
                                  }
                              }
                              
                              if (participantData) {
                                  stats.participants.push(participantData);
                              }
                          } catch (err) {
                              console.error(`${fork.owner.login} ì²˜ë¦¬ ì‹¤íŒ¨:`, err.message);
                          }
                      }));
                      
                      // API ì œí•œ ëŒ€ë¹„ ì§€ì—°
                      await new Promise(resolve => setTimeout(resolve, 500));
                  }
                  
                  // í‰ê·  ì—°ì† ì£¼ì°¨ ë° ì„±ê³µë¥  ê³„ì‚°
                  if (stats.participants.length > 0) {
                      // ì—°ì† ì£¼ì°¨ê°€ 0ì´ ì•„ë‹Œ ì°¸ì—¬ìë“¤ë§Œìœ¼ë¡œ í‰ê·  ê³„ì‚° (ì‹¤íŒ¨í•œ ì‚¬ëŒ ì œì™¸)
                      const activeParticipants = stats.participants.filter(p => p.currentStreak > 0);
                      const totalStreak = activeParticipants.reduce((sum, p) => sum + p.currentStreak, 0);
                      const totalSuccessRate = stats.participants.reduce((sum, p) => sum + p.successRate, 0);
                      
                      stats.averageStreak = activeParticipants.length > 0 ? Math.round(totalStreak / activeParticipants.length * 10) / 10 : 0;
                      stats.averageSuccessRate = Math.round(totalSuccessRate / stats.participants.length * 10) / 10;
                      
                      // ë­í‚¹ ë°ì´í„° ìƒì„± (ì—°ì† ì£¼ì°¨ ìˆœ)
                      stats.rankingByStreak = [...stats.participants]
                          .sort((a, b) => b.currentStreak - a.currentStreak)
                          .slice(0, 20); // ìƒìœ„ 20ëª…ë§Œ
                      
                      // ë­í‚¹ ë°ì´í„° ìƒì„± (ì„±ê³µë¥  ìˆœ)  
                      stats.rankingBySuccessRate = [...stats.participants]
                          .sort((a, b) => b.successRate - a.successRate)
                          .slice(0, 20); // ìƒìœ„ 20ëª…ë§Œ
                      
                      // ë­í‚¹ ë°ì´í„° ìƒì„± (ìµœì¥ ì—°ì† ì£¼ì°¨ ìˆœ)
                      stats.rankingByMaxStreak = [...stats.participants]
                          .sort((a, b) => b.maxStreak - a.maxStreak)
                          .slice(0, 20); // ìƒìœ„ 20ëª…ë§Œ
                  }
                  
                  // statistics.json íŒŒì¼ë¡œ ì €ì¥
                  console.log('statistics.json íŒŒì¼ì— í†µê³„ ì €ì¥ ì¤‘...');
                  
                  // í†µê³„ ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥
                  const jsonData = JSON.stringify(stats, null, 2);
                  fs.writeFileSync('statistics.json', jsonData);
                  console.log('statistics.json íŒŒì¼ ì €ì¥ ì™„ë£Œ');
                  
                  console.log('í†µê³„ ìˆ˜ì§‘ ë° ì €ì¥ ì™„ë£Œ!');
                  
              } catch (error) {
                  console.error('í†µê³„ ìˆ˜ì§‘ ì‹¤íŒ¨:', error);
                  process.exit(1);
              }
          }
          
          collectStatistics();
          EOF
      
      - name: Commit statistics file
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add statistics.json
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“Š Update statistics $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M')"
            git push
          else
            echo "í†µê³„ íŒŒì¼ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi